<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONO-NEXUS | Professional Watch Registry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-base: #fcfcf9; 
            --bg-sub: #f5f5f2;  
            --text-primary: #1a1a1a; 
            --text-secondary: #70706b; 
            --accent-color: #10b981; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-base);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .glass {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.02);
        }

        .grainy-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 50% 50%, var(--bg-base) 0%, var(--bg-sub) 100%);
        }

        /* カテゴリー行ホバー：黒い線 */
        .registry-row {
            transition: background-color 0.3s ease;
        }
        .registry-row td:first-child {
            border-left: 4px solid transparent;
            transition: border-left-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .registry-row:hover {
            background-color: rgba(0, 0, 0, 0.015) !important;
        }
        .registry-row:hover td:first-child {
            border-left-color: #000;
        }

        /* SOLDラベル */
        .sold-ribbon {
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            overflow: hidden;
            z-index: 10;
        }
        .sold-ribbon::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            border-style: solid;
            border-width: 0 60px 60px 0;
            border-color: transparent #ef4444 transparent transparent;
        }
        .sold-ribbon span {
            position: absolute;
            top: 10px;
            right: 1px;
            display: block;
            width: 70px;
            color: #fff;
            font-size: 8px;
            font-weight: 900;
            text-transform: uppercase;
            text-align: center;
            transform: rotate(45deg);
            letter-spacing: 0.1em;
        }

        /* スター（ウォッチリスト）アイコン：斜体にならないように修正 */
        .star-icon {
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: rgba(0,0,0,0.1);
            font-style: normal !important; /* 直立させる */
            display: inline-block;
        }
        .star-icon:hover {
            transform: scale(1.3);
            color: #fbbf24;
        }
        .star-icon.active {
            color: #fbbf24;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }

        /* 画像編集エリア */
        #image-edit-container {
            cursor: move;
            touch-action: none;
            background: #fff;
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            overflow: hidden;
            border-radius: 24px;
            border: 1px solid rgba(0,0,0,0.06);
        }

        .view-transition { transition: opacity 0.4s ease, transform 0.4s ease; }
        .hidden-view { display: none !important; opacity: 0; transform: translateY(10px); }

        .price-glow { text-shadow: 0 0 15px rgba(16, 185, 129, 0.1); }
        .btn-hover:hover { transform: scale(1.02); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); }

        .tab-btn {
            position: relative;
            padding: 8px 16px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: #70706b;
            transition: all 0.3s;
        }
        .tab-btn.active {
            color: #000;
        }
        .tab-btn.active::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 16px;
            right: 16px;
            height: 2px;
            background: #000;
        }

        .filter-chip {
            padding: 6px 14px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 100px;
            transition: all 0.2s;
            background: white;
            color: #70706b;
        }
        .filter-chip.active {
            background: #000;
            color: #fff;
            border-color: #000;
        }

        #toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            transform: translateY(300px); 
            opacity: 0;
            pointer-events: none;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
        }
        #toast.show { transform: translateY(0); opacity: 1; pointer-events: auto; }

        @media (max-width: 768px) { .hide-mobile { display: none; } }
    </style>
</head>
<body class="antialiased">
    <div class="grainy-bg"></div>
    <div id="three-canvas" class="fixed inset-0 pointer-events-none z-0 opacity-20"></div>

    <nav class="fixed top-0 w-full z-50 glass border-b border-black/[0.03]">
        <div class="max-w-[1600px] mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-8">
                <div class="text-2xl font-black tracking-tighter text-black cursor-pointer" onclick="showListView()">CHRONO-NEXUS</div>
                <div class="hidden md:flex space-x-6 text-[10px] font-bold uppercase tracking-[0.2em] text-neutral-400">
                    <a href="#" class="hover:text-black transition" onclick="showListView()">マーケット</a>
                    <a href="#" class="hover:text-black transition" onclick="toggleMainTab('history')">売買履歴</a>
                </div>
            </div>
            <button onclick="openModal()" class="px-8 py-2.5 bg-black text-white rounded-full text-[10px] font-black uppercase tracking-widest hover:bg-neutral-800 transition shadow-lg active:scale-95 transition-all">
                Sell Watch
            </button>
        </div>
    </nav>

    <!-- 1. メイン画面 -->
    <main id="list-view" class="view-transition pt-32 pb-24">
        <div class="max-w-[1600px] mx-auto px-6">
            
            <div id="main-header" class="mb-12">
                <h1 id="main-title" class="text-5xl font-black tracking-tighter uppercase italic text-black leading-tight">Market Dashboard</h1>
                <p id="main-subtitle" class="text-[10px] text-neutral-400 font-bold uppercase tracking-[0.3em] mt-2 italic">Authorized Global Watch Registry</p>
                
                <div class="flex items-center space-x-2 mt-8 border-b border-black/5 pb-2">
                    <button onclick="toggleMainTab('collection')" id="tab-collection" class="tab-btn active font-black italic">Collection</button>
                    <button onclick="toggleMainTab('watchlist')" id="tab-watchlist" class="tab-btn font-black italic">Watchlist</button>
                    <button onclick="toggleMainTab('history')" id="tab-history" class="tab-btn font-black italic">Market Activity</button>
                </div>
            </div>

            <!-- コレクション表示用 -->
            <div id="collection-container" class="glass rounded-[32px] overflow-hidden border border-black/[0.03] mb-24 bg-white/30">
                <table id="collection-table" class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[9px] text-neutral-400 uppercase tracking-[0.2em] font-black border-b border-black/[0.03] bg-black/[0.01]">
                            <th class="pl-8 py-4 w-12 text-center italic opacity-60">☆</th>
                            <th class="px-4 py-4 w-16 text-center italic opacity-60">ID</th>
                            <th class="px-4 py-4">Collection Series</th>
                            <th class="px-4 py-4">最安値</th>
                            <th class="px-4 py-4 text-right pr-8">パフォーマンス</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-black/[0.02] text-sm font-mono italic" id="collection-body"></tbody>
                </table>
            </div>

            <!-- 売買履歴表示用 -->
            <div id="global-history-container" class="hidden glass rounded-[32px] overflow-hidden border border-black/[0.03] mb-24 bg-white/40">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[9px] text-neutral-400 uppercase tracking-[0.2em] font-black border-b border-black/[0.03] bg-black/[0.01]">
                            <th class="pl-8 py-6 w-24">Item</th>
                            <th class="px-4 py-6">Date</th>
                            <th class="px-4 py-6">Reference Model</th>
                            <th class="px-4 py-6">Series</th>
                            <th class="px-4 py-6">Type</th>
                            <th class="px-4 py-6 text-right pr-8">Price</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-black/[0.02] text-sm font-mono italic" id="global-history-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 2. カテゴリー詳細 -->
    <main id="detail-view" class="hidden-view pt-32 pb-24 text-black">
        <div class="max-w-[1400px] mx-auto px-6">
            <button onclick="showListView()" class="mb-10 text-[10px] font-bold text-neutral-400 hover:text-black transition uppercase tracking-widest italic">← Back to Market</button>
            <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-8 border-b border-black/[0.05] pb-12">
                <div class="flex items-center gap-10">
                    <div class="w-40 h-40 rounded-3xl overflow-hidden border border-black/[0.05] shadow-2xl bg-white relative p-1.5">
                        <img id="detail-image" src="" alt="Category Image" class="w-full h-full object-cover rounded-[26px]">
                    </div>
                    <div>
                        <div class="flex items-center space-x-3 mb-1">
                            <p id="detail-ref-prefix" class="text-neutral-400 text-[10px] font-bold uppercase tracking-widest font-mono italic">RX-REG-000</p>
                            <span id="detail-star" class="star-icon text-lg" onclick="toggleWatchlistFromDetail()">★</span>
                        </div>
                        <h1 id="detail-title" class="text-6xl font-black tracking-tighter italic uppercase text-black leading-none">Series</h1>
                        <button id="btn-category-history" class="mt-4 text-[9px] font-black uppercase tracking-[0.2em] text-emerald-600 hover:text-emerald-800 transition">View Series Activity →</button>
                    </div>
                </div>
                <div class="flex gap-4 font-mono italic">
                    <div class="glass px-8 py-6 rounded-2xl border border-black/[0.03] bg-white/80">
                        <p class="text-[9px] text-neutral-400 uppercase mb-1 font-bold tracking-widest text-center">最安値</p>
                        <div class="text-3xl font-black text-black price-glow">¥<span id="detail-price">0</span>〜</div>
                    </div>
                    <div class="glass px-8 py-6 rounded-2xl border border-black/[0.03] flex flex-col justify-center items-center min-w-[140px]">
                        <p class="text-[9px] text-neutral-400 uppercase mb-1 font-bold tracking-widest text-center">Analytics</p>
                        <div id="detail-change" class="text-xl font-black">0%</div>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                <div class="flex items-center space-x-2">
                    <span class="text-[8px] font-black text-neutral-400 uppercase tracking-widest mr-2 italic">Condition:</span>
                    <button onclick="updateFilter('all')" class="filter-chip active" data-filter="all">すべて</button>
                    <button onclick="updateFilter('新品')" class="filter-chip" data-filter="新品">新品</button>
                    <button onclick="updateFilter('中古')" class="filter-chip" data-filter="中古">中古</button>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-[8px] font-black text-neutral-400 uppercase tracking-widest mr-2 italic">Sort:</span>
                    <button onclick="updateSort('default')" class="filter-chip active" data-sort="default">標準</button>
                    <button onclick="updateSort('price-asc')" class="filter-chip" data-sort="price-asc">価格が安い順</button>
                    <button onclick="updateSort('price-desc')" class="filter-chip" data-sort="price-desc">価格が高い順</button>
                </div>
            </div>

            <div id="detail-listings-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
        </div>
    </main>

    <!-- 3. 個別商品詳細 -->
    <main id="item-view" class="hidden-view pt-32 pb-24 text-black">
        <div class="max-w-[1200px] mx-auto px-6">
            <button id="btn-back-to-category" class="mb-10 text-[10px] font-bold text-neutral-400 hover:text-black transition group uppercase tracking-widest italic">← Back to Series</button>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">
                <div class="glass rounded-[48px] overflow-hidden aspect-square bg-white shadow-3xl relative border border-black/[0.05] p-2.5" id="item-detail-image-container">
                    <img id="item-detail-image" src="" class="w-full h-full object-cover rounded-[40px]">
                </div>
                <div class="flex flex-col justify-center">
                    <h2 id="item-detail-category" class="text-neutral-400 text-[10px] font-bold uppercase tracking-widest mb-2 italic font-mono">Registry Class</h2>
                    <h1 id="item-detail-title" class="text-5xl font-black tracking-tighter mb-6 uppercase italic text-black leading-tight">Reference</h1>
                    <div class="glass p-10 rounded-[40px] border border-black/[0.04] italic bg-white/20">
                        <div class="flex flex-col gap-6 mb-8 font-mono italic">
                            <div class="border-l-4 border-black pl-6">
                                <p class="text-[11px] text-neutral-400 mb-1 font-bold uppercase">鑑定価格</p>
                                <div class="text-5xl font-black text-black italic tracking-tighter price-glow">¥<span id="item-detail-price">0</span></div>
                                <div id="item-detail-condition-badge" class="mt-2 inline-block px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest shadow-sm text-white">新品</div>
                            </div>
                            <div class="flex justify-between items-center pt-6 border-t border-black/[0.05]">
                                <p class="text-[11px] text-neutral-400 font-bold uppercase tracking-widest italic">Current High offer</p>
                                <div id="item-detail-highest-offer" class="text-3xl font-black text-emerald-600 leading-none">¥0</div>
                            </div>
                        </div>
                        <p id="item-detail-description" class="text-xs text-neutral-500 leading-relaxed mb-10 italic opacity-80"></p>
                        <div class="flex gap-4">
                            <button id="buy-button" class="flex-1 bg-black text-white py-5 rounded-2xl font-black text-xs uppercase tracking-[0.4em] btn-hover shadow-lg active:scale-95 transition-all disabled:opacity-30" onclick="handlePurchaseClick()">BUY / 注文を確定する</button>
                            <button id="btn-item-offer" class="flex-1 glass text-black py-5 rounded-2xl font-black text-xs uppercase tracking-[0.4em] btn-hover border-black/10 transition-all active:scale-95 disabled:opacity-30" onclick="openOfferModal(null, currentFilteringItem)">Place offer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- モーダル・トースト -->
    <div id="listing-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 overflow-y-auto">
        <div class="glass w-full max-w-5xl p-10 rounded-[48px] shadow-3xl relative border border-black/10 my-auto bg-white overflow-hidden text-black">
            <button onclick="closeModal()" class="absolute top-10 right-10 text-neutral-400 hover:text-black transition z-50 font-black uppercase text-[10px] tracking-widest italic">Close</button>
            <form id="listing-form" onsubmit="handleListingSubmit(event)" class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div class="space-y-6">
                    <h2 class="text-3xl font-black tracking-tighter uppercase italic text-black">New Entry</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-1 italic">Series</label>
                            <select id="form-category" required class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black font-bold text-black text-xs italic"></select>
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-1 italic">Reference No.</label>
                            <input type="text" id="form-name" required placeholder="REF..." class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black text-black text-xs font-bold uppercase">
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-1 italic">鑑定価格 (JPY)</label>
                            <input type="number" id="form-price" required placeholder="0" class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black text-black text-xs font-mono font-bold">
                        </div>
                    </div>
                </div>
                <div class="flex flex-col items-center gap-6">
                    <div id="image-edit-container" class="shadow-2xl border-2 border-dashed border-neutral-100">
                        <input type="file" id="form-image" accept="image/*" onchange="initImageEditor(event)" class="absolute inset-0 opacity-0 cursor-pointer z-30">
                        <div id="preview-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-neutral-300 p-8 text-center font-black uppercase tracking-widest text-[9px] italic">Tap to Upload</div>
                        <img id="image-editor-target" src="" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 origin-center select-none" style="max-width: none; max-height: none;">
                    </div>
                    <button type="submit" class="w-full bg-black text-white py-5 rounded-2xl font-black text-xs uppercase tracking-[0.4em] btn-hover shadow-xl italic active:scale-95 transition-all">Authorize Entry</button>
                </div>
            </form>
        </div>
    </div>

    <div id="offer-modal" class="fixed inset-0 z-[150] hidden items-center justify-center p-6 text-black italic">
        <div class="glass w-full max-w-md p-10 rounded-[48px] border border-black/10 shadow-3xl bg-white/95">
            <button onclick="closeOfferModal()" class="absolute top-10 right-10 text-gray-400 hover:text-black transition italic uppercase font-black text-[10px] tracking-widest">Close</button>
            <h2 class="text-3xl font-black tracking-tighter mb-2 uppercase italic text-black">Place Proposal</h2>
            <p id="offer-item-name" class="text-neutral-400 text-[10px] font-bold uppercase tracking-widest mb-10 italic">REF NAME</p>
            <form onsubmit="handleOfferSubmit(event)" class="space-y-8">
                <div><label class="block text-[11px] font-bold text-gray-400 uppercase tracking-[0.3em] mb-4 italic font-mono text-center">Current Peak offer</label><div id="offer-current-best" class="w-full bg-neutral-50 border border-black/30 rounded-2xl px-6 py-6 font-mono text-emerald-600 italic font-black text-3xl italic leading-none text-center shadow-inner">¥0</div></div>
                <div><label class="block text-[11px] font-bold text-gray-400 uppercase tracking-[0.3em] mb-4 italic font-mono text-center">Your Proposal (JPY)</label><input type="number" id="form-offer-price" required placeholder="Enter amount..." class="w-full bg-neutral-50 border border-black/10 rounded-2xl px-6 py-6 outline-none focus:border-black text-black text-3xl font-bold font-mono italic leading-none transition-all text-center"></div>
                <button type="submit" class="w-full bg-black text-white py-7 rounded-[32px] font-black text-[12px] uppercase tracking-[0.5em] shadow-xl active:scale-95 transition-all shadow-lg italic">Confirm offer</button>
            </form>
        </div>
    </div>

    <div id="toast" class="glass px-12 py-6 rounded-full border border-black/[0.04] shadow-2xl flex items-center space-x-8 italic text-black">
        <div class="w-12 h-12 bg-black rounded-full flex items-center justify-center text-white font-black text-2xl shadow-lg">!</div>
        <div><p class="text-[13px] font-black uppercase tracking-[0.4em] text-black italic" id="toast-title">Information</p><p id="toast-message" class="text-[11px] text-neutral-400 italic font-mono tracking-tighter uppercase mt-1">Confirmed.</p></div>
    </div>

    <script>
        const categories = [
            { id: 1, name: 'シードゥエラー', floor: '1,850,000', change: '+4.30%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/49-5os8cromlu1m5otpcim3xb2w-Main.png' },
            { id: 2, name: 'デイデイト', floor: '6,200,000', change: '+0.45%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/47-v5b06z1h6pcvqe8xu0e9h2pg-Main.png' },
            { id: 3, name: 'スカイドゥエラー', floor: '3,800,000', change: '+15.2%', img: 'https://img.chrono24.com/images/uhren/44213405-j3dbv1oq7gk0bq2n6z761rzc-Square280.jpg' },
            { id: 4, name: 'レディデイトジャスト', floor: '1,100,000', change: '+1.10%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/53-qr7rjp3uwl4jco6w9zezewr6-Main.png' },
            { id: 5, name: 'デイトジャスト', floor: '1,420,000', change: '+1.20%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/45-w36w6el32cnbsnxr0smetc2y-Main.png' },
            { id: 6, name: 'オイスターパーペチュアル', floor: '980,000', change: '+5.75%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/55-vb2javyk3a8rlddxgy6lkr33-Main.png' },
            { id: 7, name: 'コスモグラフデイトナ', floor: '4,850,000', change: '+12.45%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/2-y181jdh67kx2lripaucfting-Main.png' },
            { id: 8, name: 'サブマリーナー', floor: '1,550,000', change: '+0.85%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/1-w70x429knb132x17edf24c63-Main.png' },
            { id: 9, name: 'ヨットマスター', floor: '2,150,000', change: '-1.10%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/59-64dbjwtbd3y6580vuf2h85z0-Main.png' },
            { id: 10, name: 'ディープシー', floor: '2,350,000', change: '-3.45%', img: 'https://img.chrono24.com/images/uhren/43678494-ryljxvmm8al1ucvis0x81b41-Square280.jpg' },
            { id: 11, name: 'エクスプローラー', floor: '1,120,000', change: '+1.45%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/51-92wkn1hz3jvvyfqzhu1yjwxy-Main.png' },
            { id: 12, name: 'ミルガウス', floor: '1,650,000', change: '+5.10%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/54-83a5t6w7ocqe7bm8y9kigmt3-Main.png' },
            { id: 13, name: 'GMTマスターⅡ', floor: '2,950,000', change: '-2.30%', img: 'https://i.postimg.cc/fTHBMQPK/sukurinshotto-2025-12-25-174221.png' },
            { id: 14, name: 'エアキング', floor: '1,150,000', change: '+2.15%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/5-1gfc76l6jakp6ckprhhuypse-Main.png' }
        ];

        const transactionHistory = [
            { id: 'TX-9004', date: '2025.12.24', itemName: 'シードゥエラー Ref.MOD-102', categoryName: 'シードゥエラー', categoryId: 1, type: 'SALE', price: '1,920,000', image: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/49-5os8cromlu1m5otpcim3xb2w-Main.png' },
            { id: 'TX-9003', date: '2025.12.23', itemName: 'デイデイト Ref.MOD-108', categoryName: 'デイデイト', categoryId: 2, type: 'SALE', price: '6,450,000', image: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/47-v5b06z1h6pcvqe8xu0e9h2pg-Main.png' }
        ];

        const individualListings = [];
        const categorySamples = {};
        const watchlist = new Set(); 

        let activeCategoryId = null;
        let currentFilteringItem = null;
        let currentFilter = 'all';
        let currentSort = 'default';
        let currentMainTab = 'collection'; 

        let tbody, listView, detailView, itemView, globalHistoryBody, listingsGrid, modal, offerModal, categorySelect;
        let editorImgEl, editorContainer;

        function initializeDOMElements() {
            tbody = document.getElementById('collection-body');
            listView = document.getElementById('list-view');
            detailView = document.getElementById('detail-view');
            itemView = document.getElementById('item-view');
            globalHistoryBody = document.getElementById('global-history-body');
            listingsGrid = document.getElementById('detail-listings-grid');
            modal = document.getElementById('listing-modal');
            offerModal = document.getElementById('offer-modal');
            categorySelect = document.getElementById('form-category');
            editorImgEl = document.getElementById('image-editor-target');
            editorContainer = document.getElementById('image-edit-container');
        }

        // --- ウォッチリスト制御 ---
        function toggleWatchlist(event, id) {
            if (event) event.stopPropagation();
            if (watchlist.has(id)) watchlist.delete(id);
            else watchlist.add(id);
            if (currentMainTab === 'collection' || currentMainTab === 'watchlist') renderList();
            if (activeCategoryId === id) updateDetailStar();
        }
        function toggleWatchlistFromDetail() { if (activeCategoryId) toggleWatchlist(null, activeCategoryId); }
        function updateDetailStar() {
            const star = document.getElementById('detail-star');
            if (star) {
                star.innerText = watchlist.has(activeCategoryId) ? '★' : '☆';
                star.classList.toggle('active', watchlist.has(activeCategoryId));
            }
        }

        // --- フィルター・ソート制御 ---
        function updateFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('[data-filter]').forEach(el => el.classList.toggle('active', el.dataset.filter === filter));
            if (activeCategoryId) renderDetailListings(activeCategoryId);
        }
        function updateSort(sort) {
            currentSort = sort;
            document.querySelectorAll('[data-sort]').forEach(el => el.classList.toggle('active', el.dataset.sort === sort));
            if (activeCategoryId) renderDetailListings(activeCategoryId);
        }

        // --- メインタブ制御 ---
        function toggleMainTab(tab) {
            currentMainTab = tab;
            const collectionCont = document.getElementById('collection-container');
            const historyCont = document.getElementById('global-history-container');
            const tabs = { collection: 'tab-collection', watchlist: 'tab-watchlist', history: 'tab-history' };
            const title = document.getElementById('main-title');
            const subtitle = document.getElementById('main-subtitle');

            showListView();
            Object.values(tabs).forEach(id => document.getElementById(id).classList.remove('active'));
            document.getElementById(tabs[tab]).classList.add('active');

            if (tab === 'history') {
                collectionCont.classList.add('hidden'); historyCont.classList.remove('hidden');
                title.innerText = 'Market Activity'; subtitle.innerText = 'Verified Global Transaction Logs';
                renderGlobalHistory();
            } else {
                collectionCont.classList.remove('hidden'); historyCont.classList.add('hidden');
                title.innerText = tab === 'collection' ? 'Market Dashboard' : 'Your Watchlist';
                subtitle.innerText = tab === 'collection' ? 'Authorized Global Watch Registry' : 'Curated Registry References';
                renderList();
            }
        }

        function renderGlobalHistory(catId = null) {
            if(!globalHistoryBody) return; globalHistoryBody.innerHTML = '';
            const filtered = catId ? transactionHistory.filter(t => t.categoryId === catId) : transactionHistory;
            if(filtered.length === 0) {
                globalHistoryBody.innerHTML = `<tr><td colspan="6" class="py-20 text-center opacity-40 uppercase tracking-widest italic">No registry entries found</td></tr>`;
                return;
            }
            filtered.forEach(tx => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-black/[0.01] transition-all';
                row.innerHTML = `
                    <td class="pl-8 py-4"><div class="w-12 h-12 rounded-full overflow-hidden border border-black/5 bg-white shadow-sm p-0.5"><img src="${tx.image}" class="w-full h-full object-cover rounded-full"></div></td>
                    <td class="px-4 py-6 opacity-40">${tx.date}</td>
                    <td class="px-4 py-6 font-black uppercase italic">${tx.itemName}</td>
                    <td class="px-4 py-6 text-[10px] uppercase font-bold opacity-60">${tx.categoryName}</td>
                    <td class="px-4 py-6"><span class="px-2 py-0.5 rounded-full text-[8px] font-black uppercase tracking-tighter bg-emerald-100 text-emerald-800">SALE</span></td>
                    <td class="px-4 py-6 text-right pr-8 font-black text-black leading-none">¥${tx.price}</td>
                `;
                globalHistoryBody.appendChild(row);
            });
        }

        // --- 基本ロジック ---
        function hideAllViews() { [listView, detailView, itemView].forEach(v => { if(v){ v.style.display = 'none'; v.classList.add('hidden-view'); } }); }
        function showListView() { activeCategoryId = null; hideAllViews(); if(listView){ listView.style.display = 'block'; setTimeout(() => { listView.classList.remove('hidden-view'); }, 50); } }

        function showDetail(id) {
            activeCategoryId = id; const cat = categories.find(c => c.id === id);
            document.getElementById('detail-title').innerText = cat.name;
            document.getElementById('detail-price').innerText = cat.floor;
            document.getElementById('detail-change').innerText = cat.change;
            document.getElementById('detail-change').className = `text-xl font-black ${cat.change.startsWith('+') ? 'text-emerald-600' : 'text-red-600'}`;
            document.getElementById('detail-image').src = cat.img;
            document.getElementById('detail-ref-prefix').innerText = `RX-REG-${id.toString().padStart(3, '0')}`;
            updateDetailStar();
            document.getElementById('btn-category-history').onclick = () => { toggleMainTab('history'); renderGlobalHistory(id); };
            currentFilter = 'all'; currentSort = 'default'; updateFilter('all'); updateSort('default');
            hideAllViews(); if(detailView){ detailView.style.display = 'block'; setTimeout(() => detailView.classList.remove('hidden-view'), 50); }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showItemDetail(item) {
            currentFilteringItem = item;
            document.getElementById('item-detail-image').src = item.image;
            document.getElementById('item-detail-title').innerText = item.name;
            document.querySelectorAll('#item-detail-price').forEach(el => el.innerText = item.price);
            document.getElementById('item-detail-highest-offer').innerText = item.highestOffer > 0 ? `¥${item.highestOffer.toLocaleString()}` : "--";
            const imgContainer = document.getElementById('item-detail-image-container');
            const oldSold = imgContainer.querySelector('.sold-ribbon'); if (oldSold) oldSold.remove();
            if (item.sold) {
                const soldLabel = document.createElement('div'); soldLabel.className = 'sold-ribbon'; soldLabel.innerHTML = '<span>SOLD</span>';
                imgContainer.appendChild(soldLabel);
                document.getElementById('buy-button').disabled = true; document.getElementById('btn-item-offer').disabled = true;
                document.getElementById('buy-button').innerText = 'SOLD OUT';
            } else {
                document.getElementById('buy-button').disabled = false; document.getElementById('btn-item-offer').disabled = false;
                document.getElementById('buy-button').innerText = 'BUY / 注文を確定する';
            }
            const badge = document.getElementById('item-detail-condition-badge');
            if (badge) {
                badge.innerText = item.condition;
                badge.className = `mt-2 inline-block px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest shadow-sm text-white ${item.condition === '新品' ? 'bg-black' : 'bg-red-600'}`;
            }
            document.getElementById('btn-back-to-category').onclick = () => showDetail(item.categoryId);
            hideAllViews(); if(itemView){ itemView.style.display = 'block'; setTimeout(() => itemView.classList.remove('hidden-view'), 50); }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function handlePurchaseClick() {
            if (!currentFilteringItem) return;
            currentFilteringItem.sold = true;
            const now = new Date();
            const dateStr = `${now.getFullYear()}.${(now.getMonth()+1).toString().padStart(2, '0')}.${now.getDate().toString().padStart(2, '0')}`;
            transactionHistory.unshift({ id: `TX-${Date.now().toString().slice(-4)}`, date: dateStr, itemName: currentFilteringItem.name, categoryName: categories.find(c => c.id === currentFilteringItem.categoryId).name, categoryId: currentFilteringItem.categoryId, type: 'SALE', price: currentFilteringItem.price, image: currentFilteringItem.image });
            showToast("Order Accepted", "Order confirmed. Archiving record.");
            showItemDetail(currentFilteringItem);
        }

        function openOfferModal(event, item) {
            if (event) event.stopPropagation(); if (item.sold) return;
            currentFilteringItem = item;
            document.getElementById('offer-item-name').innerText = item.name;
            document.getElementById('offer-current-best').innerText = item.highestOffer > 0 ? `¥${item.highestOffer.toLocaleString()}` : "¥0";
            if (offerModal) offerModal.style.display = 'flex';
        }
        function closeOfferModal() { if (offerModal) offerModal.style.display = 'none'; }
        function handleOfferSubmit(event) {
            event.preventDefault();
            const offerVal = parseInt(document.getElementById('form-offer-price').value);
            if (!currentFilteringItem) return;
            if (offerVal > (currentFilteringItem.highestOffer || 0)) {
                currentFilteringItem.highestOffer = offerVal;
                showToast("Identity Verified", `Proposal of ¥${offerVal.toLocaleString()} logged.`);
                if (itemView.style.display === 'block') document.getElementById('item-detail-highest-offer').innerText = `¥${offerVal.toLocaleString()}`;
                if (activeCategoryId) renderDetailListings(activeCategoryId);
            } else { showToast("Warning", "New offer must exceed current peak."); }
            closeOfferModal(); document.getElementById('form-offer-price').value = "";
        }

        function renderList() {
            if (!tbody) return; tbody.innerHTML = '';
            let filteredCategories = categories;
            if (currentMainTab === 'watchlist') filteredCategories = categories.filter(c => watchlist.has(c.id));
            
            if (filteredCategories.length === 0 && currentMainTab === 'watchlist') {
                tbody.innerHTML = '<tr><td colspan="5" class="py-24 text-center opacity-30 italic uppercase font-black tracking-widest text-black">Watchlist is empty</td></tr>';
                return;
            }

            filteredCategories.forEach((cat, i) => {
                const isPositive = cat.change.startsWith('+');
                const isWatched = watchlist.has(cat.id);
                const row = document.createElement('tr'); 
                row.className = 'registry-row cursor-pointer group italic text-black transition-all';
                row.onclick = () => showDetail(cat.id);
                row.innerHTML = `
                    <td class="pl-8 py-6 text-center"><span onclick="toggleWatchlist(event, ${cat.id})" class="star-icon ${isWatched ? 'active' : ''}">${isWatched ? '★' : '☆'}</span></td>
                    <td class="px-4 py-6 text-neutral-400 text-[10px] font-black italic text-center opacity-40 group-hover:opacity-100 group-hover:text-black font-mono">${(i + 1).toString().padStart(2, '0')}</td>
                    <td class="px-4 py-4 flex items-center space-x-6">
                        <div class="w-16 h-16 rounded-2xl overflow-hidden border border-black/[0.04] group-hover:scale-105 transition-all shadow-lg bg-neutral-50 p-0.5"><img src="${cat.img}" class="w-full h-full object-cover rounded-2xl"></div>
                        <div class="font-black uppercase text-black transition italic text-lg tracking-tighter">${cat.name}</div>
                    </td>
                    <td class="px-4 py-6"><div class="inline-flex items-center glass px-4 py-2 rounded-full border border-black/[0.08] bg-white/40 text-black font-black text-base italic shadow-sm">¥${cat.floor}〜</div></td>
                    <td class="px-4 py-6 text-right pr-12 font-bold italic font-mono text-base tracking-widest ${isPositive ? 'text-emerald-600' : 'text-red-600'} opacity-40 group-hover:opacity-100 transition-all">${cat.change}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderDetailListings(catId) {
            if(!listingsGrid) return; listingsGrid.innerHTML = '';
            if(!categorySamples[catId]) {
                categorySamples[catId] = []; const cat = categories.find(c=>c.id===catId);
                const basePrice = parseInt(cat.floor.replace(/,/g, ''));
                for(let i=0; i<15; i++) {
                    const randomPrice = basePrice + Math.floor(Math.random() * 50) * 10000;
                    categorySamples[catId].push({ id: `s-${catId}-${i}`, categoryId: catId, name: `${cat.name} Ref.MOD-${100 + i}`, price: randomPrice.toLocaleString(), priceVal: randomPrice, condition: Math.random() > 0.4 ? "中古" : "新品", image: cat.img, highestOffer: Math.floor(randomPrice * (0.8 + Math.random() * 0.2)), sold: false });
                }
            }
            let allItems = [...(individualListings.filter(l=>l.categoryId === catId)), ...categorySamples[catId]];
            if (currentFilter !== 'all') allItems = allItems.filter(item => item.condition === currentFilter);
            if (currentSort === 'price-asc') allItems.sort((a, b) => a.priceVal - b.priceVal);
            else if (currentSort === 'price-desc') allItems.sort((a, b) => b.priceVal - a.priceVal);

            allItems.forEach(item => {
                const card = document.createElement('div'); 
                card.className = 'glass rounded-[40px] p-4 border border-black/[0.04] cursor-pointer hover:border-black transition-all flex flex-col h-full shadow-lg italic group bg-white/30 hover:bg-white/70 overflow-hidden relative';
                card.onclick = () => showItemDetail(item);
                const condColor = item.condition === "新品" ? "bg-black" : "bg-red-600";
                card.innerHTML = `
                    ${item.sold ? '<div class="sold-ribbon"><span>SOLD</span></div>' : ''}
                    <div class="aspect-square rounded-[28px] overflow-hidden mb-4 bg-neutral-50 relative shadow-inner border border-black/[0.03] p-1 ${item.sold ? 'opacity-50' : ''}"><img src="${item.image}" class="w-full h-full object-cover rounded-[24px] transition-transform duration-700 group-hover:scale-105"><div class="absolute top-4 left-4 ${condColor} text-white px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest shadow-sm">${item.condition}</div></div>
                    <div class="font-mono text-black flex-grow flex flex-col justify-between px-1 ${item.sold ? 'opacity-30' : ''}"><h4 class="font-black text-[11px] uppercase leading-tight truncate mb-2 group-hover:text-emerald-600 transition-colors">${item.name}</h4><div class="flex justify-between items-baseline pt-2"><div class="text-xl font-black text-black italic tracking-tighter leading-none price-glow"><span class="text-[10px] mr-1 opacity-20 italic">¥</span>${item.price}</div><div class="text-right"><span class="text-[7px] text-gray-400 uppercase font-bold block mb-0.5">offer</span><span class="text-[10px] font-black text-emerald-600 leading-none">¥${item.highestOffer.toLocaleString()}</span></div></div></div>
                `;
                listingsGrid.appendChild(card);
            });
        }

        // --- 初期化ロジック ---
        function initImageEditor(event) {
            const file = event.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    editorImgEl.src = img.src; editorImgEl.classList.remove('hidden');
                    document.getElementById('preview-placeholder').classList.add('hidden');
                    editorState = { isDragging: false, startX:0, startY:0, currentX:0, currentY:0, baseScale: Math.min(editorContainer.offsetWidth/img.width, editorContainer.offsetWidth/img.height), zoom:1, rotate:0, flip:false, brightness:100, contrast:100 };
                    updateVisuals();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        window.addEventListener('load', () => { initializeDOMElements(); initThree(); animate(); renderList(); if(categorySelect) categorySelect.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); });
        function openModal() { if(modal) modal.style.display = 'flex'; }
        function closeModal() { if(modal) modal.style.display = 'none'; document.getElementById('listing-form').reset(); editorImgEl.src = ""; editorImgEl.classList.add('hidden'); }
        function showToast(t, m) { const ts = document.getElementById('toast'); if(ts){ ts.querySelector('#toast-title').innerText = t; ts.querySelector('#toast-message').innerText = m; ts.classList.add('show'); setTimeout(()=>ts.classList.remove('show'), 3500); } }
        async function handleListingSubmit(event) {
            event.preventDefault(); const catId = parseInt(categorySelect.value); const price = parseInt(document.getElementById('form-price').value);
            const fImg = editorImgEl.src ? await captureCroppedImage() : categories.find(c=>c.id===catId).img;
            individualListings.unshift({ id: Date.now(), categoryId: catId, name: document.getElementById('form-name').value, price: price.toLocaleString(), priceVal: price, condition: "中古", image: fImg, isUserListed: true, highestOffer: 0, sold: false });
            closeModal(); showToast("Success", "Registry entry confirmed."); if (activeCategoryId === catId) renderDetailListings(catId);
        }
        let scene, camera, renderer, cube;
        function initThree() {
            const container = document.getElementById('three-canvas'); if(!container) return;
            scene = new THREE.Scene(); camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({alpha:true, antialias:true}); renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);
            cube = new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(4.5, 4.5, 4.5)), new THREE.LineBasicMaterial({color:0x000000, linewidth: 1.2}));
            scene.add(cube); camera.position.z = 10;
            window.onresize = () => { renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); };
        }
        function animate() { requestAnimationFrame(animate); if(cube){ cube.rotation.x+=0.0008; cube.rotation.y+=0.0008; } renderer.render(scene, camera); }
    </script>
</body>
</html>
