<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONO-NEXUS | Professional Watch Registry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-base: #fcfcf9; 
            --bg-sub: #f5f5f2;  
            --text-primary: #1a1a1a; 
            --text-secondary: #70706b; 
            --accent-color: #10b981; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-base);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .glass {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.02);
        }

        .grainy-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 50% 50%, var(--bg-base) 0%, var(--bg-sub) 100%);
        }

        .registry-row { transition: background-color 0.3s ease; }
        .registry-row td:first-child { border-left: 4px solid transparent; transition: border-left-color 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .registry-row:hover { background-color: rgba(0, 0, 0, 0.015) !important; }
        .registry-row:hover td:first-child { border-left-color: #000; }

        .sold-ribbon { position: absolute; top: 0; right: 0; width: 60px; height: 60px; overflow: hidden; z-index: 10; }
        .sold-ribbon::before { content: ""; position: absolute; top: 0; right: 0; border-style: solid; border-width: 0 60px 60px 0; border-color: transparent #ef4444 transparent transparent; }
        .sold-ribbon span { position: absolute; top: 10px; right: 1px; display: block; width: 70px; color: #fff; font-size: 8px; font-weight: 900; text-transform: uppercase; text-align: center; transform: rotate(45deg); letter-spacing: 0.1em; font-family: 'Inter', sans-serif; }

        .star-icon, .heart-icon { cursor: pointer; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-style: normal !important; display: inline-block; }
        .star-icon { color: rgba(0, 0, 0, 0.3); font-size: 1.2rem; }
        .star-icon.active { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }

        .heart-icon {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(0, 0, 0, 0.1);
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; font-size: 0.9rem;
            position: absolute; top: 10px; right: 10px; z-index: 30;
            backdrop-filter: blur(4px);
        }
        .heart-icon:hover { transform: scale(1.1); color: #f87171; background: rgba(0,0,0,0.2); }
        .heart-icon.active { color: #ef4444; background: rgba(255, 255, 255, 0.9); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2); }

        #image-edit-container {
            cursor: pointer;
            background: #fdfdfb;
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            overflow: hidden;
            border-radius: 32px;
            border: 2px dashed rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        #image-edit-container:hover { border-color: rgba(0,0,0,0.2); background: #f8f8f6; }

        .view-transition { transition: opacity 0.4s ease, transform 0.4s ease; }
        .hidden-view { display: none !important; opacity: 0; transform: translateY(10px); }

        .price-glow { text-shadow: 0 0 15px rgba(16, 185, 129, 0.1); }
        .btn-hover:hover { transform: scale(1.02); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); }

        .tab-btn { position: relative; padding: 8px 16px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.2em; color: #70706b; transition: all 0.3s; border: none; background: transparent; cursor: pointer; }
        .tab-btn.active { color: #000; }
        .tab-btn.active::after { content: ""; position: absolute; bottom: -2px; left: 16px; right: 16px; height: 2px; background: #000; }

        .filter-chip { padding: 6px 14px; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; border: 1px solid rgba(0,0,0,0.05); border-radius: 100px; transition: all 0.2s; background: white; color: #70706b; cursor: pointer; }
        .filter-chip.active { background: #000; color: #fff; border-color: #000; }

        #toast { position: fixed; bottom: 30px; right: 30px; transform: translateY(400px); opacity: 0; pointer-events: none; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 5000; }
        #toast.show { transform: translateY(0); opacity: 1; pointer-events: auto; }
        
        .verify-banner { background: #fee2e2; color: #991b1b; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; padding: 12px; text-align: center; width: 100%; position: fixed; top: 64px; z-index: 45; border-bottom: 1px solid rgba(153, 27, 27, 0.1); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="antialiased">
    <div class="grainy-bg"></div>
    <div id="three-canvas" class="fixed inset-0 pointer-events-none z-0 opacity-20"></div>

    <div id="verify-banner" class="verify-banner hidden">
        <span>メール認証を完了してください。機能が制限されています。</span>
        <button onclick="window.resendVerification()" class="ml-4 underline hover:text-black font-black uppercase text-black text-black text-black text-black">再送する</button>
        <button onclick="window.reloadUser()" class="ml-4 px-4 py-1 bg-white rounded-full border border-red-200 hover:bg-red-50 transition font-black italic text-black">認証しました</button>
    </div>

    <nav class="fixed top-0 w-full z-50 glass border-b border-black/[0.03]">
        <div class="max-w-[1600px] mx-auto px-6 py-4 flex justify-between items-center text-black">
            <div class="flex items-center space-x-8">
                <div class="text-2xl font-black tracking-tighter cursor-pointer text-black" onclick="window.showListView()">CHRONO-NEXUS</div>
                <div class="hidden md:flex space-x-6 text-[10px] font-bold uppercase tracking-[0.2em] text-neutral-400">
                    <a href="#" class="hover:text-black transition" onclick="window.showListView()">マーケット</a>
                    <a href="#" class="hover:text-black transition" onclick="window.toggleMainTab('history')">売買履歴</a>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div id="auth-status-container" class="flex items-center space-x-4 text-black text-black text-black text-black">
                    <button id="btn-auth-trigger" onclick="window.openAuthModal()" class="text-[10px] font-black uppercase tracking-widest text-neutral-400 hover:text-black transition px-4 text-neutral-400">Sign In</button>
                </div>
                <button onclick="window.openModal()" class="px-8 py-2.5 bg-black text-white rounded-full text-[10px] font-black uppercase tracking-widest hover:bg-neutral-800 transition shadow-lg active:scale-95 transition-all">
                    Sell Watch
                </button>
            </div>
        </div>
    </nav>

    <!-- メイン -->
    <main id="list-view" class="view-transition pt-32 pb-24 text-black">
        <div class="max-w-[1600px] mx-auto px-6">
            <div id="main-header" class="mb-12">
                <h1 id="main-title" class="text-5xl font-black tracking-tighter uppercase italic text-black leading-tight">Market Dashboard</h1>
                <p id="main-subtitle" class="text-[10px] text-neutral-400 font-bold uppercase tracking-[0.3em] mt-2 italic text-neutral-400">Authorized Global Watch Registry</p>
                <div class="flex items-center space-x-2 mt-8 border-b border-black/5 pb-2 overflow-x-auto whitespace-nowrap">
                    <button onclick="window.toggleMainTab('collection')" id="tab-collection" class="tab-btn active font-black italic">Collection</button>
                    <button onclick="window.toggleMainTab('watchlist')" id="tab-watchlist" class="tab-btn font-black italic">Watchlist</button>
                    <button onclick="window.toggleMainTab('favorites')" id="tab-favorites" class="tab-btn font-black italic">Favorites</button>
                    <button onclick="window.toggleMainTab('history')" id="tab-history" class="tab-btn font-black italic text-black">Market Activity</button>
                </div>
            </div>
            <div id="collection-container" class="glass rounded-[32px] overflow-hidden border border-black/[0.03] mb-24 bg-white/30 text-black">
                <table id="collection-table" class="w-full text-left border-collapse text-black text-black">
                    <thead>
                        <tr class="text-[9px] text-neutral-400 uppercase font-black bg-black/[0.01]">
                            <th class="pl-8 py-5 w-12 text-center opacity-60">☆</th>
                            <th class="px-4 py-5 w-16 text-center italic opacity-60">ID</th>
                            <th>Collection Series</th>
                            <th>最安値</th>
                            <th class="px-4 py-5 text-right pr-8">パフォーマンス</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-black/[0.02] text-sm font-mono italic" id="collection-body"></tbody>
                </table>
            </div>
            <div id="favorites-container" class="hidden mb-24 text-black"><div id="favorites-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div></div>
            <div id="global-history-container" class="hidden glass rounded-[32px] overflow-hidden border border-black/[0.03] mb-24 bg-white/40 text-black text-black">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[9px] text-neutral-400 uppercase font-black bg-black/[0.01] border-b border-black/[0.03]">
                            <th class="pl-8 py-6 w-24">Item</th><th>Date</th><th>Reference</th><th>Series</th><th>Type</th><th class="text-right pr-8">Price</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-black/[0.02] text-sm font-mono italic text-black" id="global-history-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- カテゴリー詳細 -->
    <main id="detail-view" class="hidden-view pt-32 pb-24 text-black">
        <div class="max-w-[1400px] mx-auto px-6">
            <button onclick="window.showListView()" class="mb-10 text-[10px] font-bold text-neutral-400 hover:text-black transition uppercase tracking-widest italic">← Back to Market</button>
            <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-8 border-b border-black/[0.05] pb-12">
                <div class="flex items-center gap-10 text-black">
                    <div class="w-40 h-40 rounded-3xl overflow-hidden border border-black/[0.05] shadow-2xl bg-white relative p-1.5"><img id="detail-image" src="" class="w-full h-full object-cover rounded-[26px]"></div>
                    <div>
                        <div class="flex items-center space-x-3 mb-1 text-black"><p id="detail-ref-prefix" class="text-neutral-400 text-[10px] font-bold uppercase tracking-widest font-mono italic text-black text-black">RX-REG-000</p><span id="detail-star" class="star-icon" onclick="window.toggleWatchlistFromDetail()">☆</span></div>
                        <h1 id="detail-title" class="text-6xl font-black tracking-tighter italic uppercase text-black leading-none text-black">Series</h1>
                        <div class="flex items-center space-x-4 mt-6">
                            <button onclick="window.toggleDetailTab('collection')" id="detail-tab-collection" class="tab-btn active font-black italic text-black">Collection</button>
                            <button onclick="window.toggleDetailTab('history')" id="detail-tab-history" class="tab-btn font-black italic text-black">Activity</button>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 font-mono italic text-black">
                    <div class="glass px-8 py-6 rounded-2xl border border-black/[0.03] bg-white/80 text-center text-black"><p class="text-[9px] text-neutral-400 uppercase mb-1 font-bold tracking-widest">最安値</p><div class="text-3xl font-black text-black price-glow">¥<span id="detail-price">0</span>〜</div></div>
                    <div class="glass px-8 py-6 rounded-2xl border border-black/[0.03] flex flex-col justify-center items-center min-w-[140px] text-center text-black"><p class="text-[9px] text-neutral-400 uppercase mb-1 font-bold tracking-widest text-center text-neutral-400">Analytics</p><div id="detail-change" class="text-xl font-black">0%</div></div>
                </div>
            </div>
            <div id="detail-collection-view"><div id="detail-listings-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 text-black text-black text-black"></div></div>
            <div id="detail-history-view" class="hidden text-black"><div class="glass rounded-[32px] overflow-hidden border border-black/[0.03] bg-white/40 text-black text-black"><table class="w-full text-left border-collapse text-black text-black"><thead><tr class="text-[9px] text-neutral-400 uppercase font-black border-b border-black/[0.03] text-black text-black"><th class="pl-8 py-6 w-24">Item</th><th>Date</th><th>Reference</th><th class="text-right pr-8">Price</th></tr></thead><tbody class="divide-y divide-black/[0.02] text-sm font-mono italic" id="detail-history-body"></tbody></table></div></div>
        </div>
    </main>

    <!-- 商品詳細 -->
    <main id="item-view" class="hidden-view pt-32 pb-24 text-black text-black">
        <div class="max-w-[1200px] mx-auto px-6">
            <button id="btn-back-to-category" class="mb-10 text-[10px] font-bold text-neutral-400 hover:text-black transition uppercase tracking-widest italic">← Back to Series</button>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 text-black">
                <div class="glass rounded-[48px] overflow-hidden aspect-square bg-white shadow-3xl relative border border-black/[0.05] p-2.5 text-black" id="item-detail-image-container"><img id="item-detail-image" src="" class="w-full h-full object-cover rounded-[40px]"></div>
                <div class="flex flex-col justify-center text-black">
                    <h2 id="item-detail-category" class="text-neutral-400 text-[10px] font-bold uppercase tracking-widest mb-2 italic font-mono text-neutral-400 text-black">Registry Class</h2>
                    <h1 id="item-detail-title" class="text-5xl font-black tracking-tighter mb-6 uppercase italic text-black leading-tight text-black">Reference</h1>
                    <div class="glass p-10 rounded-[40px] border border-black/[0.04] italic bg-white/20 text-black text-black text-black">
                        <div class="flex flex-col gap-6 mb-8 font-mono italic text-black text-black text-black"><div class="border-l-4 border-black pl-6 text-black text-black"><p class="text-[11px] text-neutral-400 mb-1 font-bold uppercase text-neutral-400">鑑定価格</p><div class="text-5xl font-black text-black italic tracking-tighter price-glow text-black">¥<span id="item-detail-price">0</span></div><div id="item-detail-condition-badge" class="mt-2 inline-block px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest shadow-sm text-white">新品</div></div></div>
                        <div class="flex justify-between items-center pt-6 border-t border-black/[0.05] text-black mb-8 text-black text-black"><p class="text-[11px] text-neutral-400 font-bold uppercase tracking-widest italic text-neutral-400 text-black">Current High offer</p><div id="item-detail-highest-offer" class="text-3xl font-black text-emerald-600 leading-none">¥0</div></div>
                        <p id="item-detail-description" class="text-xs text-neutral-500 leading-relaxed mb-10 italic opacity-80 h-24 overflow-y-auto pr-2 text-black text-black"></p>
                        <div class="flex gap-4 text-black text-black text-black"><button id="buy-button" class="flex-1 bg-black text-white py-5 rounded-2xl font-black text-xs uppercase tracking-[0.4em] btn-hover shadow-lg active:scale-95 transition-all text-white" onclick="window.handlePurchaseClick()">BUY / 注文を確定する</button><button id="btn-item-offer" class="flex-1 glass text-black py-5 rounded-2xl font-black text-xs uppercase tracking-[0.4em] btn-hover border-black/10 transition-all active:scale-95 text-black" onclick="window.openOfferModal(null, window.currentFilteringItem)">Place offer</button></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 認証モーダル -->
    <div id="auth-modal" class="fixed inset-0 z-[200] hidden items-center justify-center p-4 overflow-y-auto text-black">
        <div class="glass w-full max-w-md p-10 rounded-[48px] shadow-3xl relative border border-black/10 my-auto bg-white overflow-hidden text-center text-black">
            <button onclick="window.closeAuthModal()" class="absolute top-10 right-10 text-neutral-400 hover:text-black transition z-50 font-black uppercase text-[10px] tracking-widest italic text-black">Close</button>
            <h2 id="auth-modal-title" class="text-3xl font-black tracking-tighter uppercase italic text-black mb-2 text-black">Member Registry</h2>
            <form id="auth-form" onsubmit="window.handleAuthSubmit(event)" class="space-y-4 text-black text-black text-black">
                <input type="email" id="auth-email" placeholder="EMAIL ADDRESS" required class="w-full bg-neutral-50 border border-black/5 rounded-2xl px-6 py-4 outline-none focus:border-black font-bold text-black text-[10px] uppercase tracking-widest text-center">
                <input type="password" id="auth-password" placeholder="PASSWORD" required class="w-full bg-neutral-50 border border-black/5 rounded-2xl px-6 py-4 outline-none focus:border-black font-bold text-black text-[10px] uppercase tracking-widest text-center">
                <button type="submit" id="btn-auth-submit" class="w-full bg-black text-white py-5 rounded-2xl font-black text-xs uppercase tracking-[0.4em] btn-hover shadow-xl italic mt-4 active:scale-95 transition-all text-white">Sign In</button>
                <div class="pt-6 border-t border-black/5 text-black"><button type="button" onclick="window.toggleAuthMode()" id="btn-auth-toggle" class="text-[9px] font-bold text-neutral-400 hover:text-black transition uppercase tracking-widest italic text-black">Create New Account</button></div>
            </form>
        </div>
    </div>

    <!-- 出品モーダル -->
    <div id="listing-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 overflow-y-auto text-black text-black text-black text-black text-black text-black text-black text-black text-black">
        <div class="glass w-full max-w-5xl p-10 rounded-[48px] shadow-3xl relative border border-black/10 my-auto bg-white overflow-hidden text-black text-black text-black">
            <button onclick="window.closeModal()" class="absolute top-10 right-10 text-neutral-400 hover:text-black transition z-50 font-black uppercase text-[10px] tracking-widest italic text-black">Close</button>
            <form id="listing-form" onsubmit="window.handleListingSubmit(event)" class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div class="space-y-6 text-left text-black">
                    <h2 class="text-3xl font-black tracking-tighter uppercase italic text-black text-black">New Entry</h2>
                    <div class="space-y-5 text-black">
                        <div><label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-1 italic text-neutral-400 text-black">Series</label><select id="form-category" required class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black font-bold text-black text-xs italic text-black text-black text-black text-black"></select></div>
                        <div class="grid grid-cols-2 gap-4 text-black">
                            <div><label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-1 italic text-neutral-400 text-black">Ref No.</label><input type="text" id="form-name" required placeholder="REF..." class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black text-black text-xs font-bold uppercase text-black"></div>
                            <div><label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-1 italic text-neutral-400 text-black text-black">鑑定価格 (JPY)</label><input type="number" id="form-price" required placeholder="0" class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black text-black text-xs font-mono font-bold text-black text-black text-black text-black"></div>
                        </div>
                        <div><label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-2 italic text-black text-black text-black">状態</label><select id="form-condition-select" class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black font-bold text-black text-[10px] uppercase italic transition-all text-black text-black text-black text-black text-black text-black"><option value="新品">新品</option><option value="新品同様＆未使用">新品同様＆未使用</option><option value="中古(非常に良い)">中古(非常に良い)</option><option value="中古(良い)">中古(良い)</option><option value="中古(普通)">中古(普通)</option><option value="一部に不具合あり">一部に不具合あり</option></select></div>
                        <div><label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-1 italic text-black text-black text-black text-black">商品の説明</label><textarea id="form-description" rows="3" placeholder="状態など..." class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black text-black text-xs italic leading-relaxed text-black text-black text-black text-black text-black text-black text-black text-black text-black"></textarea></div>
                    </div>
                </div>
                <div class="flex flex-col items-center gap-6 text-center text-black text-black text-black">
                    <label class="block text-[10px] font-bold text-neutral-400 uppercase tracking-widest italic text-neutral-400 text-black">Composition Control</label>
                    <div id="image-edit-container">
                        <!-- ファイル選択input：常に上に配置しエリア全体をカバー -->
                        <input type="file" id="form-image" accept="image/*" onchange="window.initImageEditor(event)" class="absolute inset-0 opacity-0 cursor-pointer z-50">
                        <div id="preview-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-neutral-300 p-8 text-center font-black uppercase tracking-widest text-[9px] italic text-neutral-300">Tap to Upload Photo</div>
                        <img id="image-editor-target" src="" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 origin-center select-none" style="max-width: none; max-height: none;">
                    </div>
                    <button type="submit" class="w-full bg-black text-white py-5 rounded-2xl font-black text-xs uppercase tracking-[0.4em] btn-hover shadow-xl italic mt-auto active:scale-95 transition-all text-white text-white">出品する</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase統合 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD94_MEE0CZi4sqNLPGRUJgY0HKIaLzCfE",
            authDomain: "chrono-953e8.firebaseapp.com",
            projectId: "chrono-953e8",
            storageBucket: "chrono-953e8.firebasestorage.app",
            messagingSenderId: "94740202916",
            appId: "1:94740202916:web:9ce13c83e6c04a5cd22d31",
            measurementId: "G-HMTQ35703G"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseTools = { auth, db, user: null };

        window.handleAuthSubmit = async function(event) {
            event.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            try {
                if (window.authMode === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                    window.showToast("Success", "Authenticated.");
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await sendEmailVerification(userCredential.user);
                    window.showToast("Verification Sent", "確認メールを送信しました。");
                }
                window.closeAuthModal();
            } catch (error) {
                window.showToast("Auth Error", error.message);
            }
        };

        window.handleLogout = async function() {
            try { await signOut(auth); window.showToast("Logged Out", "Session terminated."); } 
            catch (e) { window.showToast("Logout Error", e.message); }
        };

        window.resendVerification = async function() {
            const user = auth.currentUser;
            if (user) {
                try { await sendEmailVerification(user); window.showToast("Resent", "確認メールを再送しました。"); } 
                catch (e) { window.showToast("Error", e.message); }
            }
        };

        window.reloadUser = async function() {
            const user = auth.currentUser;
            if (user) {
                await user.reload();
                window.firebaseTools.user = auth.currentUser;
                window.updateAuthUI(auth.currentUser);
                window.showToast("Reloaded", auth.currentUser.emailVerified ? "認証完了" : "未認証");
            }
        };

        onAuthStateChanged(auth, (user) => {
            window.firebaseTools.user = user;
            if (window.updateAuthUI) window.updateAuthUI(user);
        });
    </script>

    <!-- アプリケーションロジック -->
    <script>
        const categories = [
            { id: 1, name: 'シードゥエラー', floor: '1,850,000', change: '+4.30%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/49-5os8cromlu1m5otpcim3xb2w-Main.png' },
            { id: 2, name: 'デイデイト', floor: '6,200,000', change: '+0.45%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/47-v5b06z1h6pcvqe8xu0e9h2pg-Main.png' },
            { id: 3, name: 'スカイドゥエラー', floor: '3,800,000', change: '+15.2%', img: 'https://img.chrono24.com/images/uhren/44213405-j3dbv1oq7gk0bq2n6z761rzc-Square280.jpg' },
            { id: 4, name: 'レディデイトジャスト', floor: '1,100,000', change: '+1.10%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/53-qr7rjp3uwl4jco6w9zezewr6-Main.png' },
            { id: 5, name: 'デイトジャスト', floor: '1,420,000', change: '+1.20%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/45-w36w6el32cnbsnxr0smetc2y-Main.png' },
            { id: 6, name: 'オイスターパーペチュアル', floor: '980,000', change: '+5.75%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/55-vb2javyk3a8rlddxgy6lkr33-Main.png' },
            { id: 7, name: 'コスモグラフデイトナ', floor: '4,850,000', change: '+12.45%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/2-y181jdh67kx2lripaucfting-Main.png' },
            { id: 8, name: 'サブマリーナー', floor: '1,550,000', change: '+0.85%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/1-w70x429knb132x17edf24c63-Main.png' },
            { id: 9, name: 'ヨットマスター', floor: '2,150,000', change: '-1.10%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/59-64dbjwtbd3y6580vuf2h85z0-Main.png' },
            { id: 10, name: 'ディープシー', floor: '2,350,000', change: '-3.45%', img: 'https://img.chrono24.com/images/uhren/43678494-ryljxvmm8al1ucvis0x81b41-Square280.jpg' },
            { id: 11, name: 'エクスプローラー', floor: '1,120,000', change: '+1.45%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/51-92wkn1hz3jvvyfqzhu1yjwxy-Main.png' },
            { id: 12, name: 'ミルガウス', floor: '1,650,000', change: '+5.10%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/54-83a5t6w7ocqe7bm8y9kigmt3-Main.png' },
            { id: 13, name: 'GMTマスターⅡ', floor: '2,950,000', change: '-2.30%', img: 'https://i.postimg.cc/fTHBMQPK/sukurinshotto-2025-12-25-174221.png' },
            { id: 14, name: 'エアキング', floor: '1,150,000', change: '+2.15%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/5-1gfc76l6jakp6ckprhhuypse-Main.png' }
        ];
        const transactionHistory = [{ id: 'TX-9004', date: '2025.12.24', itemName: 'シードゥエラー Ref.MOD-102', categoryName: 'シードゥエラー', categoryId: 1, type: 'SALE', price: '1,920,000', image: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/49-5os8cromlu1m5otpcim3xb2w-Main.png' }];
        const individualListings = [];
        const categorySamples = {};
        const watchlist = new Set(); 
        const favoriteItemIds = new Set(); 
        let activeCategoryId = null;
        window.currentFilteringItem = null;
        let currentFilter = 'all';
        let currentSort = 'default';
        let currentMainTab = 'collection'; 
        window.authMode = 'login';
        
        let sc, cam, rend, cub;
        let tbody, listView, detailView, itemView, globalHistoryBody, listingsGrid, modal, offerModal, categorySelect, editorImgEl, editorContainer;

        window.initializeDOMElements = function() {
            tbody = document.getElementById('collection-body');
            listView = document.getElementById('list-view');
            detailView = document.getElementById('detail-view');
            itemView = document.getElementById('item-view');
            globalHistoryBody = document.getElementById('global-history-body');
            listingsGrid = document.getElementById('detail-listings-grid');
            modal = document.getElementById('listing-modal');
            categorySelect = document.getElementById('form-category');
            editorImgEl = document.getElementById('image-editor-target');
            editorContainer = document.getElementById('image-edit-container');
        };

        window.showListView = function(push = true) {
            activeCategoryId = null;
            if (push) history.pushState({ view: 'list', tab: currentMainTab }, "");
            [listView, detailView, itemView].forEach(v => { if(v){ v.style.display = 'none'; v.classList.add('hidden-view'); } });
            if(listView){ listView.style.display = 'block'; setTimeout(() => listView.classList.remove('hidden-view'), 50); }
        };

        window.showDetail = function(id, push = true) {
            activeCategoryId = id; const cat = categories.find(c => c.id === id);
            if (push) history.pushState({ view: 'detail', id: id }, "");
            document.getElementById('detail-title').innerText = cat.name;
            document.getElementById('detail-price').innerText = cat.floor;
            document.getElementById('detail-change').innerText = cat.change;
            document.getElementById('detail-change').className = `text-xl font-black ${cat.change.startsWith('+') ? 'text-emerald-600' : 'text-red-600'}`;
            document.getElementById('detail-image').src = cat.img;
            document.getElementById('detail-ref-prefix').innerText = `RX-REG-${id.toString().padStart(3, '0')}`;
            window.updateDetailStar();
            window.toggleDetailTab('collection');
            [listView, detailView, itemView].forEach(v => { if(v){ v.style.display = 'none'; v.classList.add('hidden-view'); } });
            if(detailView){ detailView.style.display = 'block'; setTimeout(() => detailView.classList.remove('hidden-view'), 50); }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.toggleDetailTab = function(tab) {
            const collView = document.getElementById('detail-collection-view');
            const histView = document.getElementById('detail-history-view');
            const collBtn = document.getElementById('detail-tab-collection');
            const histBtn = document.getElementById('detail-tab-history');
            if (tab === 'collection') {
                collView.classList.remove('hidden'); histView.classList.add('hidden');
                collBtn.classList.add('active'); histBtn.classList.remove('active');
                window.renderDetailListings(activeCategoryId);
            } else {
                collView.classList.add('hidden'); histView.classList.remove('hidden');
                collBtn.classList.remove('active'); histBtn.classList.add('active');
                window.renderCategoryHistory(activeCategoryId);
            }
        };

        window.renderCategoryHistory = function(catId) {
            const body = document.getElementById('detail-history-body'); body.innerHTML = '';
            const filtered = transactionHistory.filter(t => t.categoryId === catId);
            if(filtered.length === 0) { body.innerHTML = `<tr><td colspan="4" class="py-20 text-center opacity-40 uppercase tracking-widest italic">No entries</td></tr>`; return; }
            filtered.forEach(tx => {
                const row = document.createElement('tr'); row.className = 'hover:bg-black/[0.01] transition-all text-black';
                row.innerHTML = `<td class="pl-8 py-4"><div class="w-12 h-12 rounded-full overflow-hidden border border-black/5 bg-white shadow-sm p-0.5"><img src="${tx.image}" class="w-full h-full object-cover rounded-full text-black"></div></td><td class="px-4 py-6 opacity-40">${tx.date}</td><td class="px-4 py-6 font-black uppercase italic">${tx.itemName}</td><td class="px-4 py-6 text-right pr-8 font-black text-black leading-none">¥${tx.price}</td>`;
                body.appendChild(row);
            });
        };

        window.toggleMainTab = function(tab, push = true) {
            currentMainTab = tab;
            const collectionCont = document.getElementById('collection-container');
            const favoritesCont = document.getElementById('favorites-container');
            const historyCont = document.getElementById('global-history-container');
            const tabs = { collection: 'tab-collection', watchlist: 'tab-watchlist', favorites: 'tab-favorites', history: 'tab-history' };
            if (push) history.pushState({ view: 'list', tab: tab }, "");
            window.showListView(false);
            Object.values(tabs).forEach(id => document.getElementById(id).classList.remove('active'));
            document.getElementById(tabs[tab]).classList.add('active');
            const title = document.getElementById('main-title');
            if (tab === 'history') {
                collectionCont.classList.add('hidden'); favoritesCont.classList.add('hidden'); historyCont.classList.remove('hidden');
                title.innerText = 'Market Activity'; window.renderGlobalHistory();
            } else if (tab === 'favorites') {
                collectionCont.classList.add('hidden'); favoritesCont.classList.remove('hidden'); historyCont.classList.add('hidden');
                title.innerText = 'Favorites'; window.renderFavoriteItems();
            } else {
                collectionCont.classList.remove('hidden'); favoritesCont.classList.add('hidden'); historyCont.classList.add('hidden');
                title.innerText = tab === 'collection' ? 'Dashboard' : 'Watchlist'; window.renderList();
            }
        };

        window.updateDetailStar = function() {
            const star = document.getElementById('detail-star');
            if (star) { star.innerText = watchlist.has(activeCategoryId) ? '★' : '☆'; star.classList.toggle('active', watchlist.has(activeCategoryId)); }
        };

        window.showItemDetail = function(item, push = true) {
            window.currentFilteringItem = item; if (push) history.pushState({ view: 'item', item: item }, "");
            const elImg = document.getElementById('item-detail-image'); if(elImg) elImg.src = item.image;
            const elTitle = document.getElementById('item-detail-title'); if(elTitle) elTitle.innerText = item.name;
            document.querySelectorAll('#item-detail-price').forEach(el => el.innerText = item.price);
            const elOffer = document.getElementById('item-detail-highest-offer'); if(elOffer) elOffer.innerText = item.highestOffer ? `¥${item.highestOffer.toLocaleString()}` : "--";
            const elDesc = document.getElementById('item-detail-description'); if(elDesc) elDesc.innerText = (item.description || "Authentication required.") + (item.accessories ? "\n\n付属品: " + item.accessories : "");
            const imgContainer = document.getElementById('item-detail-image-container');
            if(imgContainer) {
                const oldSold = imgContainer.querySelector('.sold-ribbon'); if (oldSold) oldSold.remove();
                if (item.sold) {
                    const soldLabel = document.createElement('div'); soldLabel.className = 'sold-ribbon'; soldLabel.innerHTML = '<span>SOLD</span>';
                    imgContainer.appendChild(soldLabel);
                    const btnBuy = document.getElementById('buy-button'); if(btnBuy){ btnBuy.disabled = true; btnBuy.innerText = 'SOLD OUT'; }
                } else {
                    const btnBuy = document.getElementById('buy-button'); if(btnBuy){ btnBuy.disabled = false; btnBuy.innerText = 'BUY / 注文を確定する'; }
                }
            }
            [listView, detailView, itemView].forEach(v => { if(v){ v.style.display = 'none'; v.classList.add('hidden-view'); } });
            if(itemView){ itemView.style.display = 'block'; setTimeout(() => itemView.classList.remove('hidden-view'), 50); }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.toggleWatchlist = (e, id) => { if (e) e.stopPropagation(); if (watchlist.has(id)) watchlist.delete(id); else watchlist.add(id); window.renderList(); if (activeCategoryId === id) window.updateDetailStar(); };
        window.toggleFavoriteItem = (e, itemId) => { if (e) e.stopPropagation(); if (favoriteItemIds.has(itemId)) favoriteItemIds.delete(itemId); else favoriteItemIds.add(itemId); window.renderDetailListings(activeCategoryId); if (currentMainTab === 'favorites') window.renderFavoriteItems(); };
        window.updateFilter = (f) => { currentFilter = f; document.querySelectorAll('[data-filter]').forEach(el => el.classList.toggle('active', el.dataset.filter === f)); if (activeCategoryId) window.renderDetailListings(activeCategoryId); };
        window.updateSort = (s) => { currentSort = s; document.querySelectorAll('[data-sort]').forEach(el => el.classList.toggle('active', el.dataset.sort === s)); if (activeCategoryId) window.renderDetailListings(activeCategoryId); };

        window.renderList = () => {
            if (!tbody) return; tbody.innerHTML = '';
            categories.forEach((cat, i) => {
                if (currentMainTab === 'watchlist' && !watchlist.has(cat.id)) return;
                const row = document.createElement('tr'); row.className = 'registry-row cursor-pointer group italic text-black transition-all'; row.onclick = () => window.showDetail(cat.id);
                row.innerHTML = `<td class="pl-8 py-7 text-center"><span onclick="window.toggleWatchlist(event, ${cat.id})" class="star-icon ${watchlist.has(cat.id) ? 'active' : ''}">${watchlist.has(cat.id) ? '★' : '☆'}</span></td><td class="px-4 py-7 text-neutral-400 text-[10px] font-black font-mono center opacity-40 group-hover:opacity-100 group-hover:text-black">${(i + 1).toString().padStart(2, '0')}</td><td class="px-4 py-6 flex items-center space-x-6"><div class="w-16 h-16 rounded-2xl overflow-hidden border border-black/[0.04] group-hover:scale-105 transition-all shadow-lg bg-neutral-50 p-0.5"><img src="${cat.img}" class="w-full h-full object-cover rounded-2xl"></div><div class="font-black uppercase text-black italic text-lg tracking-tighter">${cat.name}</div></td><td class="px-4 py-7 text-black"><div class="inline-flex items-center glass px-4 py-2 rounded-full border border-black/[0.08] bg-white/40 text-black font-black text-base italic shadow-sm">¥${cat.floor}〜</div></td><td class="px-4 py-7 text-right pr-12 font-bold italic font-mono text-base tracking-widest ${cat.change.startsWith('+') ? 'text-emerald-600' : 'text-red-600'} transition-all">${cat.change}</td>`;
                tbody.appendChild(row);
            });
        };

        window.renderDetailListings = (catId) => {
            if(!listingsGrid) return; listingsGrid.innerHTML = '';
            if(!categorySamples[catId]) {
                categorySamples[catId] = []; const cat = categories.find(c=>c.id===catId);
                const bp = parseInt(cat.floor.replace(/,/g, ''));
                for(let i=0; i<8; i++) {
                    const rp = bp + Math.floor(Math.random() * 50) * 10000;
                    categorySamples[catId].push({ id: `s-${catId}-${i}`, categoryId: catId, name: `${cat.name} Ref.MOD-${100+i}`, price: rp.toLocaleString(), priceVal: rp, condition: Math.random() > 0.4 ? "中古(非常に良い)" : "新品", image: cat.img, highestOffer: Math.floor(rp * 0.9), sold: false, description: "Registry validated.", accessories: "全てあり" });
                }
            }
            let items = [...(individualListings.filter(l=>l.categoryId === catId)), ...categorySamples[catId]];
            if (currentFilter !== 'all') items = items.filter(it => it.condition.includes(currentFilter));
            if (currentSort === 'price-asc') items.sort((a,b) => a.priceVal - b.priceVal);
            else if (currentSort === 'price-desc') items.sort((a,b) => b.priceVal - a.priceVal);
            items.forEach(it => {
                const card = document.createElement('div'); card.className = 'glass rounded-[40px] p-4 border border-black/[0.04] cursor-pointer hover:border-black transition-all flex flex-col h-full shadow-lg italic group bg-white/30 hover:bg-white/70 overflow-hidden relative text-black text-black text-black'; card.onclick = () => window.showItemDetail(it);
                card.innerHTML = `<div class="aspect-square rounded-[28px] overflow-hidden mb-4 bg-neutral-50 relative shadow-inner border border-black/[0.03] p-1 text-black ${it.sold ? 'opacity-50' : ''}"><span onclick="window.toggleFavoriteItem(event, '${it.id}')" class="heart-icon ${favoriteItemIds.has(it.id) ? 'active' : ''}">${favoriteItemIds.has(it.id) ? '❤' : '♡'}</span>${it.sold ? '<div class="sold-ribbon"><span>SOLD</span></div>' : ''}<img src="${it.image}" class="w-full h-full object-cover rounded-[24px] transition-transform duration-700 group-hover:scale-105 text-black"><div class="absolute top-4 left-4 ${it.condition.includes('新品') ? 'bg-black' : 'bg-red-600'} text-white px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest shadow-sm text-white">${it.condition}</div></div><div class="font-mono text-black flex-grow flex flex-col justify-between px-1 ${it.sold ? 'opacity-30' : ''} text-black text-black"><h4 class="font-black text-[11px] uppercase truncate mb-2 group-hover:text-emerald-600 transition-colors text-black text-black">${it.name}</h4><div class="flex justify-between items-baseline pt-2 text-black text-black text-black"><div class="text-xl font-black text-black italic tracking-tighter leading-none price-glow text-black">¥${it.price}</div><div class="text-right text-black text-black"><span class="text-[7px] text-gray-400 uppercase font-bold block mb-0.5">offer</span><span class="text-[10px] font-black text-emerald-600 leading-none text-black">¥${it.highestOffer.toLocaleString()}</span></div></div></div>`;
                listingsGrid.appendChild(card);
            });
        };

        window.renderFavoriteItems = () => {
            const grid = document.getElementById('favorites-grid'); grid.innerHTML = '';
            let favs = [];
            Object.values(categorySamples).forEach(arr => arr.forEach(it => { if (favoriteItemIds.has(it.id)) favs.push(it); }));
            individualListings.forEach(it => { if (favoriteItemIds.has(it.id)) favs.push(it); });
            if (favs.length === 0) { grid.innerHTML = '<div class="col-span-full py-24 text-center opacity-30 italic uppercase font-black tracking-widest text-black">No favorites yet.</div>'; return; }
            favs.forEach(it => {
                const card = document.createElement('div'); card.className = 'glass rounded-[40px] p-4 border border-black/[0.04] cursor-pointer hover:border-black transition-all flex flex-col h-full shadow-lg italic group bg-white/30 hover:bg-white/70 overflow-hidden relative text-black text-black text-black text-black text-black'; card.onclick = () => window.showItemDetail(it);
                card.innerHTML = `<div class="aspect-square rounded-[28px] overflow-hidden mb-4 bg-neutral-50 relative shadow-inner border border-black/[0.03] p-1 text-black ${it.sold ? 'opacity-50' : ''}"><span onclick="window.toggleFavoriteItem(event, '${it.id}')" class="heart-icon active">❤</span>${it.sold ? '<div class="sold-ribbon"><span>SOLD</span></div>' : ''}<img src="${it.image}" class="w-full h-full object-cover rounded-[24px] transition-transform duration-700 group-hover:scale-105 text-black"><div class="absolute top-4 left-4 ${it.condition.includes('新品') ? 'bg-black' : 'bg-red-600'} text-white px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest shadow-sm text-white">${it.condition}</div></div><div class="font-mono text-black flex-grow flex flex-col justify-between px-1 ${it.sold ? 'opacity-30' : ''} text-black text-black text-black"><h4 class="font-black text-[11px] uppercase truncate mb-2 group-hover:text-emerald-600 transition-colors text-black text-black">${it.name}</h4><div class="flex justify-between items-baseline pt-2 text-black text-black text-black text-black text-black text-black"><div class="text-xl font-black text-black italic tracking-tighter leading-none price-glow text-black"><span class="text-xl mr-1 italic text-black">¥</span>${it.price}</div><div class="text-right text-black text-black text-black text-black text-black"><span class="text-[7px] text-gray-400 uppercase font-bold block mb-0.5 text-neutral-400 text-black">offer</span><span class="text-[10px] font-black text-emerald-600 leading-none text-black">¥${it.highestOffer.toLocaleString()}</span></div></div></div>`;
                grid.appendChild(card);
            });
        };

        window.renderGlobalHistory = () => {
            if(!globalHistoryBody) return; globalHistoryBody.innerHTML = '';
            transactionHistory.forEach(tx => {
                const row = document.createElement('tr'); row.className = 'hover:bg-black/[0.01] transition-all text-black';
                row.innerHTML = `<td class="pl-8 py-4 text-black"><div class="w-12 h-12 rounded-full overflow-hidden border border-black/5 bg-white shadow-sm p-0.5 text-black"><img src="${tx.image}" class="w-full h-full object-cover rounded-full text-black"></div></td><td class="px-4 py-6 opacity-40 text-black">${tx.date}</td><td class="px-4 py-6 font-black uppercase italic text-black text-black">${tx.itemName}</td><td class="px-4 py-6 text-[10px] uppercase font-bold opacity-60 text-black text-black">${tx.categoryName}</td><td class="px-4 py-6 text-black text-black"><span class="px-2 py-0.5 rounded-full text-[8px] font-black uppercase tracking-tighter bg-emerald-100 text-emerald-800 text-black">SALE</span></td><td class="px-4 py-6 text-right pr-8 font-black text-black leading-none text-black">¥${tx.price}</td>`;
                globalHistoryBody.appendChild(row);
            });
        };

        window.handlePurchaseClick = function() {
            if (!window.currentFilteringItem) return; window.currentFilteringItem.sold = true;
            const now = new Date(); const ds = `${now.getFullYear()}.${(now.getMonth()+1).toString().padStart(2, '0')}.${now.getDate().toString().padStart(2, '0')}`;
            transactionHistory.unshift({ id: `TX-${Date.now()}`, date: ds, itemName: window.currentFilteringItem.name, categoryName: categories.find(c => c.id === window.currentFilteringItem.categoryId).name, categoryId: window.currentFilteringItem.categoryId, type: 'SALE', price: window.currentFilteringItem.price, image: window.currentFilteringItem.image });
            window.showToast("Order Accepted", "ご注文を受け付けました。"); window.showItemDetail(window.currentFilteringItem, false);
        };

        window.openModal = () => document.getElementById('listing-modal').style.display = 'flex';
        window.closeModal = () => { document.getElementById('listing-modal').style.display = 'none'; document.getElementById('listing-form').reset(); document.getElementById('image-editor-target').src = ""; document.getElementById('image-editor-target').classList.add('hidden'); document.getElementById('preview-placeholder').classList.remove('hidden'); };
        window.showToast = (t, m) => { const el = document.getElementById('toast'); el.querySelector('#toast-title').innerText = t; el.querySelector('#toast-message').innerText = m; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 3500); };
        window.openOfferModal = (e, it) => { window.currentFilteringItem = it; document.getElementById('offer-current-best').innerText = `¥${it.highestOffer.toLocaleString()}`; document.getElementById('offer-modal').style.display = 'flex'; };
        window.closeOfferModal = () => document.getElementById('offer-modal').style.display = 'none';
        window.handleOfferSubmit = (e) => { e.preventDefault(); const val = parseInt(document.getElementById('form-offer-price').value); if (val > window.currentFilteringItem.highestOffer) { window.currentFilteringItem.highestOffer = val; window.showToast("Proposal Logged", `¥${val.toLocaleString()}`); if (itemView.style.display === 'block') document.getElementById('item-detail-highest-offer').innerText = `¥${val.toLocaleString()}`; } window.closeOfferModal(); };

        window.initImageEditor = (e) => {
            const f = e.target.files[0]; if(!f) return;
            const rd = new FileReader();
            rd.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    editorImgEl.src = img.src; editorImgEl.classList.remove('hidden');
                    document.getElementById('preview-placeholder').classList.add('hidden');
                    window.editorState = { startX:0, startY:0, currentX:0, currentY:0, zoom:1, rotate:0, baseScale: Math.min(editorContainer.offsetWidth/img.width, editorContainer.offsetWidth/img.height) };
                    window.updateVisuals();
                };
                img.src = ev.target.result;
            };
            rd.readAsDataURL(f);
        };
        window.updateVisuals = () => { const s = window.editorState.baseScale * window.editorState.zoom; editorImgEl.style.transform = `translate(calc(-50% + ${window.editorState.currentX}px), calc(-50% + ${window.editorState.currentY}px)) scale(${s}) rotate(${window.editorState.rotate}deg)`; };
        window.captureCroppedImage = async () => {
            return new Promise((res) => {
                const cv = document.createElement('canvas'); cv.width = 800; cv.height = 800;
                const ctx = cv.getContext('2d'); const img = new Image();
                img.onload = () => {
                    ctx.fillStyle = '#fdfdfb'; ctx.fillRect(0,0,800,800); ctx.save();
                    const s = window.editorState.baseScale * window.editorState.zoom * (800 / editorContainer.offsetWidth);
                    ctx.translate(400, 400); ctx.rotate((window.editorState.rotate * Math.PI) / 180);
                    ctx.drawImage(img, -img.width*s/2, -img.height*s/2, img.width*s, img.height*s); ctx.restore();
                    res(cv.toDataURL('image/jpeg', 0.8));
                };
                img.src = editorImgEl.src;
            });
        };

        window.handleListingSubmit = async (e) => {
            e.preventDefault(); const cid = parseInt(categorySelect.value); const pr = parseInt(document.getElementById('form-price').value);
            const img = editorImgEl.src ? await window.captureCroppedImage() : categories.find(c=>c.id===cid).img;
            individualListings.unshift({ id: `u-${Date.now()}`, categoryId: cid, name: document.getElementById('form-name').value, price: pr.toLocaleString(), priceVal: pr, condition: document.getElementById('form-condition-select').value, image: img, isUserListed: true, highestOffer: 0, sold: false, description: document.getElementById('form-description').value, accessories: "全てあり" });
            window.closeModal(); window.showToast("Success", "Registry confirmed."); if (activeCategoryId === cid) window.toggleDetailTab('collection');
        };

        window.openAuthModal = () => { document.getElementById('auth-modal').classList.remove('hidden'); document.getElementById('auth-modal').classList.add('flex'); };
        window.closeAuthModal = () => { document.getElementById('auth-modal').classList.add('hidden'); document.getElementById('auth-modal').classList.remove('flex'); };
        window.toggleAuthMode = () => { window.authMode = window.authMode === 'login' ? 'signup' : 'login'; document.getElementById('auth-modal-title').innerText = window.authMode === 'login' ? 'Member Registry' : 'New Registration'; document.getElementById('btn-auth-submit').innerText = window.authMode === 'login' ? 'Sign In' : 'Register Account'; document.getElementById('btn-auth-toggle').innerText = window.authMode === 'login' ? 'Create New Account' : 'Already have an account?'; };
        
        window.updateAuthUI = (u) => { 
            const c = document.getElementById('auth-status-container'); const banner = document.getElementById('verify-banner');
            if (u) { 
                c.innerHTML = `<div class="flex items-center space-x-3 text-black"><p class="text-[9px] font-black font-mono italic opacity-40 truncate max-w-[100px] text-neutral-400 text-black text-black text-black text-black">${u.email || 'User'}</p><button onclick="window.handleLogout()" class="text-[9px] font-black uppercase tracking-widest text-red-600 hover:text-red-800 transition text-black">Logout</button></div>`;
                if (!u.emailVerified) banner.classList.remove('hidden'); else banner.classList.add('hidden');
            } else { 
                c.innerHTML = `<button id="btn-auth-trigger" onclick="window.openAuthModal()" class="text-[10px] font-black uppercase tracking-widest text-neutral-400 hover:text-black transition px-4 text-neutral-400 text-black text-black text-black text-black">Sign In</button>`; 
                banner.classList.add('hidden');
            } 
        };

        window.initThree = () => {
            const cnt = document.getElementById('three-canvas'); if(!cnt) return;
            sc = new THREE.Scene(); cam = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            rend = new THREE.WebGLRenderer({alpha:true, antialias:true}); rend.setSize(window.innerWidth, window.innerHeight);
            cnt.appendChild(rend.domElement);
            cub = new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(4.5, 4.5, 4.5)), new THREE.LineBasicMaterial({color:0x000000, linewidth: 1}));
            sc.add(cub); cam.position.z = 10;
        };
        window.animate = () => { requestAnimationFrame(window.animate); if(typeof cub !== 'undefined' && cub){ cub.rotation.x+=0.0008; cub.rotation.y+=0.0008; } if(rend) rend.render(sc, cam); };

        onpopstate = (e) => {
            if (e.state) {
                const s = e.state;
                if (s.view === 'list') window.toggleMainTab(s.tab || 'collection', false);
                else if (s.view === 'detail') window.showDetail(s.id, false);
                else if (s.view === 'item') window.showItemDetail(s.item, false);
            } else window.showListView(false);
        };

        window.addEventListener('load', () => { 
            window.initializeDOMElements(); window.initThree(); window.animate(); window.renderList(); 
            const catSel = document.getElementById('form-category');
            if(catSel) catSel.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        });
    </script>
</body>
</html>
