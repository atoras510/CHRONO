<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHRONO-NEXUS | Professional Watch Registry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- 外部ライブラリ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root {
            --bg-base: #fcfcf9; 
            --bg-sub: #f5f5f2;  
            --text-primary: #1a1a1a; 
            --text-secondary: #70706b; 
            --accent-color: #10b981; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-base);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .glass {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.02);
        }

        .grainy-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 50% 50%, var(--bg-base) 0%, var(--bg-sub) 100%);
        }

        .sold-ribbon {
            position: absolute; top: 0; right: 0; width: 90px; height: 90px;
            overflow: hidden; z-index: 15;
        }
        .sold-ribbon::before {
            content: ""; position: absolute; top: 0; right: 0;
            border-style: solid; border-width: 0 90px 90px 0;
            border-color: transparent #ef4444 transparent transparent;
        }
        .sold-ribbon span {
            position: absolute; top: 18px; right: 2px; display: block; width: 100px;
            color: #fff; font-size: 10px; font-weight: 900; text-transform: uppercase;
            text-align: center; transform: rotate(45deg); letter-spacing: 0.15em;
            font-family: 'Inter', sans-serif;
        }

        /* 星アイコンのスタイル：まっすぐに修正 */
        .star-icon { 
            cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            font-style: normal !important; 
            display: inline-block; 
            color: rgba(0, 0, 0, 0.2); 
            font-size: 1.2rem;
            transform: none !important;
        }
        .star-icon.active { 
            color: #fbbf24 !important; 
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); 
        }

        .heart-icon {
            color: rgba(255, 255, 255, 0.8); background: rgba(0, 0, 0, 0.1);
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; font-size: 0.9rem; position: absolute; top: 10px; right: 10px;
            z-index: 30; backdrop-filter: blur(4px); font-style: normal;
        }
        .heart-icon.active { color: #ef4444; background: rgba(255, 255, 255, 0.9); }

        .snap-x { scroll-snap-type: x mandatory; scroll-behavior: smooth; }
        .snap-center { scroll-snap-align: center; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .nav-btn {
            transition: all 0.2s;
            opacity: 0;
            pointer-events: none;
        }
        .group:hover .nav-btn {
            opacity: 1;
            pointer-events: auto;
        }

        /* ルーペ (四角形スタイル) */
        .zoom-container { position: relative; cursor: zoom-in; }
        .loupe {
            position: absolute;
            width: 300px; height: 300px;
            border: 3px solid #fff;
            border-radius: 4px;
            box-shadow: 0 0 25px rgba(0,0,0,0.5);
            display: none;
            pointer-events: none;
            z-index: 100;
            background-repeat: no-repeat;
            background-color: #fff;
        }

        /* インジケータードット */
        .dot { transition: all 0.3s ease; }
        .dot.active { width: 14px; background-color: #000; border-radius: 4px; }

        .image-card {
            position: relative; aspect-ratio: 1/1; background: #fdfdfb; border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.05); overflow: hidden; cursor: grab;
        }
        .sortable-ghost { opacity: 0.3; background: #eee; }

        /* クロッパーカスタマイズ */
        .cropper-point {
            width: 10px !important; height: 10px !important;
            background-color: #39f !important; opacity: 1 !important;
            border-radius: 50% !important; border: 1.5px solid #fff !important;
            box-shadow: 0 0 6px rgba(0,0,0,0.4);
            z-index: 10;
        }

        .view-transition { transition: opacity 0.4s ease, transform 0.4s ease; }
        .hidden-view { display: none !important; opacity: 0; transform: translateY(10px); }

        .price-glow { text-shadow: 0 0 15px rgba(16, 185, 129, 0.1); }
        .tab-btn { position: relative; padding: 8px 16px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.2em; color: #70706b; transition: all 0.3s; border: none; background: transparent; cursor: pointer; }
        .tab-btn.active { color: #000; }
        .tab-btn.active::after { content: ""; position: absolute; bottom: -2px; left: 16px; right: 16px; height: 2px; background: #000; }

        .filter-chip { padding: 6px 14px; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; border: 1px solid rgba(0,0,0,0.05); border-radius: 100px; transition: all 0.2s; background: white; color: #70706b; cursor: pointer; }
        .filter-chip.active { background: #000; color: #fff; border-color: #000; }

        .select-styled {
            appearance: none; background-color: white; border: 1px solid rgba(0,0,0,0.05);
            padding: 8px 32px 8px 16px; border-radius: 100px; font-size: 10px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.05em; color: #1a1a1a; cursor: pointer; outline: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='black'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 12px center; background-size: 12px;
        }
    </style>
</head>
<body class="antialiased">
    <div class="grainy-bg"></div>
    <div id="three-canvas" class="fixed inset-0 pointer-events-none z-0 opacity-20"></div>

    <!-- メール認証バナー -->
    <div id="verify-banner" class="verify-banner hidden">
        <span>メール認証を完了してください。一部機能が制限されています。</span>
        <button onclick="window.resendVerification()" class="ml-4 underline hover:text-black font-black uppercase">再送する</button>
        <button onclick="window.reloadUser()" class="ml-4 px-4 py-1 bg-white rounded-full border border-red-200 hover:bg-red-50 transition font-black italic text-black">認証しました</button>
    </div>

    <nav class="fixed top-0 w-full z-50 glass border-b border-black/[0.03]">
        <div class="max-w-[1600px] mx-auto px-6 py-4 flex justify-between items-center text-black">
            <div class="flex items-center space-x-8">
                <div class="text-2xl font-black tracking-tighter cursor-pointer text-black" onclick="window.showListView()">CHRONO-NEXUS</div>
                <div class="hidden md:flex space-x-6 text-[10px] font-bold uppercase tracking-[0.2em] text-neutral-400">
                    <a href="#" class="hover:text-black transition" onclick="window.showListView()">マーケット</a>
                    <a href="#" class="hover:text-black transition" onclick="window.toggleMainTab('history')">売買履歴</a>
                </div>
            </div>
            <div class="flex items-center space-x-4 text-black">
                <div id="auth-status-container" class="flex items-center space-x-4">
                    <button onclick="window.openAuthModal()" class="text-[10px] font-black uppercase tracking-widest text-neutral-400 hover:text-black transition px-4">Sign In</button>
                </div>
                <button onclick="window.openModal()" class="px-8 py-2.5 bg-black text-white rounded-full text-[10px] font-black uppercase tracking-widest hover:bg-neutral-800 transition shadow-lg active:scale-95 transition-all text-white">
                    Sell Watch
                </button>
            </div>
        </div>
    </nav>

    <!-- メイン -->
    <main id="list-view" class="view-transition pt-32 pb-24 text-black">
        <div class="max-w-[1600px] mx-auto px-6 text-black">
            <div id="main-header" class="mb-12">
                <h1 id="main-title" class="text-5xl font-black tracking-tighter uppercase italic leading-tight text-black">Market Dashboard</h1>
                <div class="flex items-center space-x-2 mt-8 border-b border-black/5 pb-2 overflow-x-auto whitespace-nowrap scrollbar-hide text-black text-black text-black">
                    <button onclick="window.toggleMainTab('collection')" id="tab-collection" class="tab-btn active font-black italic">Collection</button>
                    <button onclick="window.toggleMainTab('watchlist')" id="tab-watchlist" class="tab-btn font-black italic">Watchlist</button>
                    <button onclick="window.toggleMainTab('favorites')" id="tab-favorites" class="tab-btn font-black italic">Favorites</button>
                    <button onclick="window.toggleMainTab('history')" id="tab-history" class="tab-btn font-black italic">Market Activity</button>
                </div>
            </div>
            <div id="collection-container" class="glass rounded-[32px] overflow-hidden border border-black/[0.03] mb-24 bg-white/30 text-black">
                <table id="collection-table" class="w-full text-left border-collapse text-black">
                    <thead>
                        <tr class="text-[9px] text-neutral-400 uppercase font-black bg-black/[0.01]">
                            <th class="pl-8 py-5 w-12 text-center opacity-60">☆</th>
                            <th class="px-4 py-5 w-16 text-center italic opacity-60">ID</th>
                            <th>Collection Series</th>
                            <th>最安値</th>
                            <th class="px-4 py-5 text-right pr-8">パフォーマンス</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-black/[0.02] text-sm font-mono italic text-black" id="collection-body"></tbody>
                </table>
            </div>
            <div id="favorites-container" class="hidden mb-24 text-black"><div id="favorites-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div></div>
            
            <div id="global-history-container" class="hidden glass rounded-[32px] overflow-hidden border border-black/[0.03] mb-24 bg-white/40 text-black">
                <table class="w-full text-left border-collapse text-black">
                    <thead>
                        <tr class="text-[9px] text-neutral-400 uppercase font-black bg-black/[0.01] border-b border-black/[0.03] text-black">
                            <th class="pl-8 py-6 w-24">Item</th><th>Date</th><th>Reference</th><th class="text-right pr-8">Price</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-black/[0.02] text-sm font-mono italic text-black" id="global-history-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- シリーズ詳細 -->
    <main id="detail-view" class="hidden-view pt-32 pb-24 text-black">
        <div class="max-w-[1400px] mx-auto px-6 text-black">
            <button onclick="window.showListView()" class="mb-10 text-[10px] font-bold text-neutral-400 hover:text-black transition uppercase tracking-widest italic">← Back to Market</button>
            <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-8 border-b border-black/[0.05] pb-12">
                <div class="flex items-center gap-10">
                    <div class="w-40 h-40 rounded-3xl overflow-hidden border border-black/[0.05] shadow-2xl bg-white relative p-1.5 text-black"><img id="detail-image" src="" class="w-full h-full object-cover rounded-[26px]"></div>
                    <div>
                        <div class="flex items-center space-x-3 mb-1"><p id="detail-ref-prefix" class="text-neutral-400 text-[10px] font-bold uppercase tracking-widest font-mono italic">RX-REG-000</p><span id="detail-star" class="star-icon" onclick="window.toggleWatchlistFromDetail()">☆</span></div>
                        <h1 id="detail-title" class="text-6xl font-black tracking-tighter italic uppercase leading-none">Series</h1>
                        <div class="flex items-center space-x-4 mt-6">
                            <button onclick="window.toggleDetailTab('collection')" id="detail-tab-collection" class="tab-btn active font-black italic">Collection</button>
                            <button onclick="window.toggleDetailTab('history')" id="detail-tab-history" class="tab-btn font-black italic">Activity</button>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 font-mono italic text-black">
                    <div class="glass px-8 py-6 rounded-2xl border border-black/[0.03] bg-white/80 text-center"><p class="text-[9px] text-neutral-400 uppercase mb-1 font-bold tracking-widest text-black">最安値</p><div class="text-3xl font-black price-glow">¥<span id="detail-price">0</span>〜</div></div>
                    <div class="glass px-8 py-6 rounded-2xl border border-black/[0.03] flex flex-col justify-center items-center min-w-[140px] text-center"><p class="text-[9px] text-neutral-400 uppercase mb-1 font-bold tracking-widest text-center">Analytics</p><div id="detail-change" class="text-xl font-black">0%</div></div>
                </div>
            </div>
            
            <div id="detail-collection-view" class="text-black">
                <div class="flex flex-wrap justify-between items-center mb-8 gap-4 px-2">
                    <div class="flex items-center space-x-2">
                        <button onclick="window.updateFilter('all')" id="filter-all" class="filter-chip active">すべて</button>
                        <button onclick="window.updateFilter('新品')" id="filter-new" class="filter-chip">新品</button>
                        <button onclick="window.updateFilter('中古')" id="filter-used" class="filter-chip">中古</button>
                    </div>
                    <select onchange="window.updateSort(this.value)" class="select-styled">
                        <option value="default">標準順</option>
                        <option value="price-asc">安い順</option>
                        <option value="price-desc">高い順</option>
                    </select>
                </div>
                <div id="detail-listings-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 text-black"></div>
            </div>

            <div id="detail-history-view" class="hidden">
                <div class="glass rounded-[32px] overflow-hidden border border-black/[0.03] bg-white/40">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-[9px] text-neutral-400 uppercase font-black bg-black/[0.01] border-b border-black/[0.03]">
                                <th class="pl-8 py-6 w-24">Item</th><th>Date</th><th>Reference</th><th class="text-right pr-8">Price</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-black/[0.02] text-sm font-mono italic" id="detail-history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- 商品個別詳細 -->
    <main id="item-view" class="hidden-view pt-32 pb-24 text-black">
        <div class="max-w-[1200px] mx-auto px-6">
            <button id="btn-back-to-category" class="mb-10 text-[10px] font-bold text-neutral-400 hover:text-black transition uppercase tracking-widest italic text-neutral-400">← Back to Series</button>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">
                <!-- カルーセル & ルーペ -->
                <div class="flex flex-col gap-6">
                    <div class="glass rounded-[48px] overflow-hidden aspect-square bg-white shadow-3xl relative border border-black/[0.05] p-2" id="item-detail-carousel-container">
                        <div id="item-carousel-track" class="w-full h-full flex snap-x snap-mandatory overflow-x-auto no-scrollbar scroll-smooth"></div>
                        <div id="carousel-dots" class="absolute bottom-8 left-0 right-0 flex justify-center space-x-2 z-20"></div>
                        <div id="carousel-counter" class="absolute top-8 right-8 bg-black/50 text-white text-[10px] font-bold px-3 py-1 rounded-full z-10 backdrop-blur-sm">1/1</div>
                    </div>
                    <div id="item-detail-thumbnails" class="flex gap-3 overflow-x-auto no-scrollbar px-2"></div>
                </div>

                <div class="flex flex-col justify-center">
                    <h2 id="item-detail-category" class="text-neutral-400 text-[10px] font-bold uppercase tracking-widest mb-2 italic font-mono">Registry Class</h2>
                    <h1 id="item-detail-title" class="text-5xl font-black tracking-tighter mb-6 uppercase italic leading-tight">Reference</h1>
                    <div class="glass p-10 rounded-[40px] border border-black/[0.04] italic bg-white/20">
                        <div class="flex flex-col gap-6 mb-8 font-mono italic">
                            <div class="border-l-4 border-black pl-6 text-black"><p class="text-[11px] text-neutral-400 mb-1 font-bold uppercase text-neutral-400">鑑定価格</p><div class="text-5xl font-black text-black italic tracking-tighter price-glow">¥<span id="item-detail-price">0</span></div><div id="item-detail-condition-badge" class="mt-2 inline-block px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest shadow-sm text-white text-white">新品</div></div>
                            <div class="flex justify-between items-center pt-6 border-t border-black/[0.05] text-black"><p class="text-[11px] text-neutral-400 font-bold uppercase tracking-widest italic">Current High offer</p><div id="item-detail-highest-offer" class="text-3xl font-black text-emerald-600 leading-none">¥0</div></div>
                        </div>
                        <p id="item-detail-description" class="text-xs text-neutral-500 leading-relaxed mb-10 italic opacity-80 h-24 overflow-y-auto pr-2"></p>
                        <div class="flex gap-4"><button id="buy-button" class="flex-1 bg-black text-white py-5 rounded-2xl font-black text-xs uppercase tracking-[0.4em] btn-hover shadow-lg active:scale-95 transition-all text-white" onclick="window.handlePurchaseClick()">BUY / 注文を確定する</button></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 出品モーダル -->
    <div id="listing-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 overflow-y-auto text-black">
        <div class="glass w-full max-w-5xl p-10 rounded-[48px] shadow-3xl relative border border-black/10 my-auto bg-white overflow-hidden">
            <button onclick="window.closeModal()" class="absolute top-10 right-10 text-neutral-400 hover:text-black transition z-50 font-black uppercase text-[10px] tracking-widest italic text-black text-black">Close</button>
            <form id="listing-form" onsubmit="window.handleListingSubmit(event)" class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div class="space-y-6 text-left">
                    <h2 class="text-3xl font-black tracking-tighter uppercase italic">New Entry</h2>
                    <div class="space-y-5">
                        <div><label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-1 italic">Series</label><select id="form-category" required class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black font-bold text-black text-xs italic"></select></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-1 italic">Ref No.</label><input type="text" id="form-name" required placeholder="REF..." class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black text-black text-xs font-bold uppercase"></div>
                            <div><label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-1 italic">鑑定価格 (JPY)</label><input type="number" id="form-price" required placeholder="0" class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black text-black text-xs font-mono font-bold"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-2 italic">状態</label><select id="form-condition-select" class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black font-bold text-black text-[10px] uppercase italic transition-all"><option value="新品">新品</option><option value="新品同様＆未使用">新品同様＆未使用</option><option value="中古(非常に良い)">中古(非常に良い)</option><option value="中古(良い)">中古(良い)</option><option value="中古(普通)">中古(普通)</option></select></div>
                            <div><label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-2 italic">付属品</label><select id="form-accessories-select" class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black font-bold text-black text-[10px] uppercase italic transition-all"><option value="全てあり">全てあり</option><option value="ボックスあり">ボックスあり</option><option value="書類あり">書類あり</option><option value="全てなし">全てなし</option></select></div>
                        </div>
                        <div><label class="block text-[9px] font-bold text-neutral-400 uppercase tracking-widest mb-1 italic">商品説明</label><textarea id="form-description" rows="3" placeholder="メンテナンス履歴など..." class="w-full bg-neutral-50 border border-black/5 rounded-xl px-4 py-3 outline-none focus:border-black text-black text-xs italic leading-relaxed"></textarea></div>
                    </div>
                </div>
                <div class="flex flex-col gap-6">
                    <label class="block text-[10px] font-bold text-neutral-400 uppercase tracking-widest italic">Market Visuals (Max 10)</label>
                    <div id="image-grid-container" class="grid grid-cols-3 gap-3 p-1 overflow-y-auto max-h-[300px] no-scrollbar">
                        <label id="upload-label" class="image-card flex flex-col items-center justify-center border-2 border-dashed border-black/5 hover:bg-black/[0.02] transition-colors order-last">
                            <input type="file" id="form-image-input" accept="image/*" multiple onchange="window.handleFileSelect(event)" class="hidden">
                            <span class="text-[18px] font-light text-neutral-300">+</span>
                            <span class="text-[7px] text-neutral-400 font-black uppercase italic">Add</span>
                        </label>
                    </div>
                    <button type="submit" class="w-full bg-black text-white py-5 rounded-2xl font-black text-xs uppercase tracking-[0.4em] btn-hover shadow-xl italic mt-auto active:scale-95 transition-all text-white text-white text-white text-white">出品する</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 画像編集用モーダル (枠ドラッグ & スクロール仕様) -->
    <div id="editor-modal" class="fixed inset-0 z-[500] hidden bg-black flex flex-col">
        <div class="flex items-center justify-between p-4 bg-black text-white border-b border-white/10 text-white text-white">
            <button onclick="window.closeEditor()" class="text-xs font-bold uppercase tracking-widest opacity-60 px-4 text-white text-white">Cancel</button>
            <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-white">Edit Visual</h3>
            <button onclick="window.saveCrop()" class="text-xs font-bold uppercase tracking-widest text-red-500 px-4 text-red-500">Done</button>
        </div>
        <div class="flex-1 bg-zinc-950 overflow-hidden relative flex items-center justify-center text-white">
            <img id="editing-image" src="" style="display: block; max-width: 100%;">
        </div>
        <div class="bg-black px-4 py-10 flex justify-center space-x-16 border-t border-white/10 text-white">
            <button onclick="window.resetEditor()" class="flex flex-col items-center text-white space-y-2">
                <div class="w-12 h-12 flex items-center justify-center rounded-full bg-white/5"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-white"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg></div>
                <span class="text-[8px] font-black uppercase tracking-widest opacity-40 text-white">Reset</span>
            </button>
            <button onclick="window.rotateEditor()" class="flex flex-col items-center text-white space-y-2">
                <div class="w-12 h-12 flex items-center justify-center rounded-full bg-white/5 text-white"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-white"><path d="M21 12H3m18-4H3m18 8H3"/><path d="M12 21V3m4 18V3m-8 18V3"/></svg></div>
                <span class="text-[8px] font-black uppercase tracking-widest opacity-40 text-white">Rotate</span>
            </button>
        </div>
    </div>

    <!-- アカウント認証モーダル -->
    <div id="auth-modal" class="fixed inset-0 z-[200] hidden items-center justify-center p-4 text-black">
        <div class="glass w-full max-w-md p-10 rounded-[48px] shadow-3xl relative border border-black/10 my-auto bg-white overflow-hidden text-center text-black text-black">
            <button onclick="window.closeAuthModal()" class="absolute top-10 right-10 text-neutral-400 hover:text-black transition z-50 font-black uppercase text-[10px] tracking-widest italic text-black">Close</button>
            <h2 id="auth-modal-title" class="text-3xl font-black tracking-tighter uppercase italic mb-2 text-black">Member Registry</h2>
            <form id="auth-form" onsubmit="window.handleAuthSubmit(event)" class="space-y-4">
                <input type="email" id="auth-email" placeholder="EMAIL ADDRESS" required class="w-full bg-neutral-50 border border-black/5 rounded-2xl px-6 py-4 outline-none focus:border-black font-bold text-[10px] uppercase tracking-widest text-center text-black">
                <input type="password" id="auth-password" placeholder="PASSWORD" required class="w-full bg-neutral-50 border border-black/5 rounded-2xl px-6 py-4 outline-none focus:border-black font-bold text-[10px] uppercase tracking-widest text-center text-black text-black">
                <button type="submit" id="btn-auth-submit" class="w-full bg-black text-white py-5 rounded-2xl font-black text-xs uppercase tracking-[0.4em] btn-hover shadow-xl italic mt-4 active:scale-95 transition-all text-white text-white">Sign In</button>
                <div class="pt-6 border-t border-black/5 text-black"><button type="button" onclick="window.toggleAuthMode()" id="btn-auth-toggle" class="text-[9px] font-bold text-neutral-400 hover:text-black transition uppercase tracking-widest italic text-black">Create New Account</button></div>
            </form>
        </div>
    </div>

    <div id="toast" class="glass px-12 py-6 rounded-full border border-black/[0.04] shadow-2xl flex items-center space-x-8 hidden z-[1000] text-black">
        <div class="w-12 h-12 bg-black rounded-full flex items-center justify-center text-white font-black text-2xl shadow-lg text-white">!</div>
        <div><p class="text-[13px] font-black uppercase tracking-[0.4em] italic text-black" id="toast-title">Information</p><p id="toast-message" class="text-[11px] text-neutral-400 italic font-mono tracking-tighter uppercase mt-1 text-black">Confirmed.</p></div>
    </div>

    <!-- Firebaseモジュール -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD94_MEE0CZi4sqNLPGRUJgY0HKIaLzCfE",
            authDomain: "chrono-953e8.firebaseapp.com",
            projectId: "chrono-953e8",
            storageBucket: "chrono-953e8.firebasestorage.app",
            messagingSenderId: "94740202916",
            appId: "1:94740202916:web:9ce13c83e6c04a5cd22d31",
            measurementId: "G-HMTQ35703G"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.firebaseTools = { auth, db, user: null };

        window.handleAuthSubmit = async function(event) {
            event.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            try {
                if (window.authMode === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                    window.showToast("Success", "Authenticated.");
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await sendEmailVerification(userCredential.user);
                    window.showToast("Verification Sent", "確認メールを送信しました。");
                }
                window.closeAuthModal();
            } catch (error) { window.showToast("Auth Error", error.message); }
        };

        window.handleLogout = async function() {
            try { await signOut(auth); window.showToast("Logged Out", "Session terminated."); } 
            catch (e) { window.showToast("Logout Error", e.message); }
        };

        window.resendVerification = async function() {
            const user = auth.currentUser;
            if (user) {
                try { await sendEmailVerification(user); window.showToast("Resent", "確認メールを再送しました。"); } 
                catch (e) { window.showToast("Error", e.message); }
            }
        };

        window.reloadUser = async function() {
            const user = auth.currentUser;
            if (user) {
                await user.reload();
                window.firebaseTools.user = auth.currentUser;
                window.updateAuthUI(auth.currentUser);
                window.showToast("Reloaded", auth.currentUser.emailVerified ? "認証完了" : "未完了");
            }
        };

        onAuthStateChanged(auth, (user) => {
            window.firebaseTools.user = user;
            if (window.updateAuthUI) window.updateAuthUI(user);
        });
    </script>

    <!-- メイン -->
    <script>
        const categories = [
            { id: 1, name: 'シードゥエラー', floor: '1,850,000', change: '+4.30%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/49-5os8cromlu1m5otpcim3xb2w-Main.png' },
            { id: 2, name: 'デイデイト', floor: '6,200,000', change: '+0.45%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/47-v5b06z1h6pcvqe8xu0e9h2pg-Main.png' },
            { id: 3, name: 'スカイドゥエラー', floor: '3,800,000', change: '+15.2%', img: 'https://img.chrono24.com/images/uhren/44213405-j3dbv1oq7gk0bq2n6z761rzc-Square280.jpg' },
            { id: 4, name: 'レディデイトジャスト', floor: '1,100,000', change: '+1.10%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/53-qr7rjp3uwl4jco6w9zezewr6-Main.png' },
            { id: 5, name: 'デイトジャスト', floor: '1,420,000', change: '+1.20%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/45-w36w6el32cnbsnxr0smetc2y-Main.png' },
            { id: 6, name: 'オイスターパーペチュアル', floor: '980,000', change: '+5.75%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/55-vb2javyk3a8rlddxgy6lkr33-Main.png' },
            { id: 7, name: 'コスモグラフデイトナ', floor: '4,850,000', change: '+12.45%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/2-y181jdh67kx2lripaucfting-Main.png' },
            { id: 8, name: 'サブマリーナー', floor: '1,550,000', change: '+0.85%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/1-w70x429knb132x17edf24c63-Main.png' },
            { id: 9, name: 'ヨットマスター', floor: '2,150,000', change: '-1.10%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/59-64dbjwtbd3y6580vuf2h85z0-Main.png' },
            { id: 10, name: 'ディープシー', floor: '2,350,000', change: '-3.45%', img: 'https://img.chrono24.com/images/uhren/43678494-ryljxvmm8al1ucvis0x81b41-Square280.jpg' },
            { id: 11, name: 'エクスプローラー', floor: '1,120,000', change: '+1.45%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/51-92wkn1hz3jvvyfqzhu1yjwxy-Main.png' },
            { id: 12, name: 'ミルガウス', floor: '1,650,000', change: '+5.10%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/54-83a5t6w7ocqe7bm8y9kigmt3-Main.png' },
            { id: 13, name: 'GMTマスターⅡ', floor: '2,950,000', change: '-2.30%', img: 'https://i.postimg.cc/fTHBMQPK/sukurinshotto-2025-12-25-174221.png' },
            { id: 14, name: 'エアキング', floor: '1,150,000', change: '+2.15%', img: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/5-1gfc76l6jakp6ckprhhuypse-Main.png' }
        ];

        const transactionHistory = [{ id: 'TX-9004', date: '2025.12.24', itemName: 'シードゥエラー Ref.MOD-102', categoryName: 'シードゥエラー', categoryId: 1, type: 'SALE', price: '1,920,000', image: 'https://cdn2.chrono24.com/cdn-cgi/image/f=auto,metadata=none,q=85/images/topmodels/49-5os8cromlu1m5otpcim3xb2w-Main.png' }];
        const individualListings = [];
        const favoriteItemIds = new Set();
        const watchlist = new Set();
        const categorySamples = {};
        let activeCategoryId = null;
        window.currentFilteringItem = null;
        let currentFilter = 'all';
        let currentSort = 'default';
        let currentMainTab = 'collection';
        window.authMode = 'login';
        window.cropper = null;
        let currentEditingCard = null;
        let imagesCount = 0;

        let sc, cam, rend, cub;
        let tbody, listView, detailView, itemView, globalHistoryBody, listingsGrid, modal, categorySelect, editorModal, editingImage, imageGrid;

        window.initializeDOMElements = function() {
            tbody = document.getElementById('collection-body');
            listView = document.getElementById('list-view');
            detailView = document.getElementById('detail-view');
            itemView = document.getElementById('item-view');
            globalHistoryBody = document.getElementById('global-history-body');
            listingsGrid = document.getElementById('detail-listings-grid');
            modal = document.getElementById('listing-modal');
            categorySelect = document.getElementById('form-category');
            editorModal = document.getElementById('editor-modal');
            editingImage = document.getElementById('editing-image');
            imageGrid = document.getElementById('image-grid-container');
            
            if(imageGrid) {
                new Sortable(imageGrid, {
                    animation: 250, ghostClass: 'sortable-ghost', filter: '#upload-label',
                    onMove: evt => evt.related.id !== 'upload-label',
                    onEnd: () => window.updateCoverBadges()
                });
            }
        };

        window.updateCoverBadges = () => {
            const cards = imageGrid.querySelectorAll('.image-card:not(#upload-label)');
            cards.forEach((card, i) => {
                let badge = card.querySelector('.cover-badge');
                if (i === 0) {
                    if (!badge) {
                        badge = document.createElement('div');
                        badge.className = 'cover-badge absolute top-0 left-0 bg-black text-white text-[7px] px-2 py-0.5 font-black uppercase italic rounded-br-lg z-10';
                        badge.textContent = 'Cover';
                        card.appendChild(badge);
                    }
                } else if (badge) { badge.remove(); }
            });
        };

        window.handleFileSelect = async (e) => {
            const files = Array.from(e.target.files);
            const remaining = 10 - imagesCount;
            for (const file of files.slice(0, remaining)) {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const squareSrc = await window.fitToSquare(event.target.result);
                    window.addImageToGrid(squareSrc, event.target.result);
                };
                reader.readAsDataURL(file);
            }
            e.target.value = '';
        };

        window.fitToSquare = (src) => {
            return new Promise(res => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const size = Math.max(img.width, img.height);
                    canvas.width = size; canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0,0,size,size);
                    ctx.drawImage(img, (size-img.width)/2, (size-img.height)/2);
                    res(canvas.toDataURL('image/jpeg', 0.9));
                };
                img.src = src;
            });
        };

        window.addImageToGrid = (displaySrc, originalSrc) => {
            if (imagesCount >= 10) return;
            const card = document.createElement('div');
            card.className = 'image-card relative aspect-square group';
            card.dataset.originalSrc = originalSrc;
            card.innerHTML = `
                <img src="${displaySrc}" class="w-full h-full object-cover">
                <button type="button" class="del-img absolute top-1 right-1 bg-black/60 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity z-20">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><path d="M18 6 6 18M6 6l12 12"/></svg>
                </button>
                <div class="edit-btn absolute bottom-0 left-0 right-0 bg-black/40 text-white text-[7px] text-center py-1.5 opacity-0 group-hover:opacity-100 transition-opacity font-black uppercase tracking-widest z-10">Edit</div>
            `;
            card.querySelector('.del-img').onclick = (e) => { e.stopPropagation(); card.remove(); imagesCount--; document.getElementById('upload-label').classList.remove('hidden'); window.updateCoverBadges(); };
            card.onclick = () => window.openEditor(card);
            imageGrid.insertBefore(card, document.getElementById('upload-label'));
            imagesCount++;
            window.updateCoverBadges();
            if (imagesCount >= 10) document.getElementById('upload-label').classList.add('hidden');
        };

        window.openEditor = (card) => {
            currentEditingCard = card;
            editingImage.src = card.dataset.originalSrc;
            editorModal.classList.remove('hidden');
            if (window.cropper) window.cropper.destroy();
            
            window.cropper = new Cropper(editingImage, {
                aspectRatio: 1, viewMode: 1, dragMode: 'crop', autoCropArea: 0.6,
                restore: false, guides: true, center: true, highlight: false,
                cropBoxMovable: true, cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
                cropmove(event) {
                    const action = event.detail.action;
                    if (action === 'all') {
                        const cropper = this.cropper;
                        const containerData = cropper.getContainerData();
                        const cropBoxData = cropper.getCropBoxData();
                        const canvasData = cropper.getCanvasData();
                        const margin = 20;
                        const speed = 8;
                        if (cropBoxData.top < margin && canvasData.top < 0) { cropper.move(0, speed); }
                        if (cropBoxData.top + cropBoxData.height > containerData.height - margin && canvasData.top + canvasData.height > containerData.height) { cropper.move(0, -speed); }
                        if (cropBoxData.left < margin && canvasData.left < 0) { cropper.move(speed, 0); }
                        if (cropBoxData.left + cropBoxData.width > containerData.width - margin && canvasData.left + canvasData.width > containerData.width) { cropper.move(-speed, 0); }
                    }
                }
            });
        };

        window.closeEditor = () => { editorModal.classList.add('hidden'); if(window.cropper) window.cropper.destroy(); window.cropper = null; };
        window.rotateEditor = () => { if(window.cropper) window.cropper.rotate(90); };
        window.resetEditor = () => { if(window.cropper) window.cropper.replace(currentEditingCard.dataset.originalSrc); };
        window.saveCrop = () => {
            if (!window.cropper) return;
            const canvas = window.cropper.getCroppedCanvas({ width: 1024, height: 1024 });
            currentEditingCard.querySelector('img').src = canvas.toDataURL('image/jpeg', 0.9);
            window.closeEditor();
        };

        window.showListView = function(push = true) {
            activeCategoryId = null;
            if (push) history.pushState({ view: 'list', tab: currentMainTab }, "");
            [listView, detailView, itemView].forEach(v => { if(v){ v.style.display = 'none'; v.classList.add('hidden-view'); } });
            if(listView){ listView.style.display = 'block'; setTimeout(() => listView.classList.remove('hidden-view'), 50); }
        };

        window.showDetail = function(id, push = true) {
            activeCategoryId = id; const cat = categories.find(c => c.id === id);
            currentFilter = 'all'; currentSort = 'default';
            if (push) history.pushState({ view: 'detail', id: id }, "");
            document.getElementById('detail-title').innerText = cat.name;
            document.getElementById('detail-price').innerText = cat.floor;
            document.getElementById('detail-change').innerText = cat.change;
            document.getElementById('detail-change').className = `text-xl font-black ${cat.change.startsWith('+') ? 'text-emerald-600' : 'text-red-600'}`;
            document.getElementById('detail-image').src = cat.img;
            document.getElementById('detail-ref-prefix').innerText = `RX-REG-${id.toString().padStart(3, '0')}`;
            window.updateDetailStar();
            window.toggleDetailTab('collection');
            [listView, detailView, itemView].forEach(v => { if(v){ v.style.display = 'none'; v.classList.add('hidden-view'); } });
            if(detailView){ detailView.style.display = 'block'; setTimeout(() => detailView.classList.remove('hidden-view'), 50); }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.toggleDetailTab = function(tab) {
            const collView = document.getElementById('detail-collection-view');
            const histView = document.getElementById('detail-history-view');
            const collBtn = document.getElementById('detail-tab-collection');
            const histBtn = document.getElementById('detail-tab-history');
            if (collView) collView.classList.toggle('hidden', tab !== 'collection');
            if (histView) histView.classList.toggle('hidden', tab !== 'history');
            if (collBtn) collBtn.classList.toggle('active', tab === 'collection');
            if (histBtn) histBtn.classList.toggle('active', tab === 'history');
            if (tab === 'collection') window.renderDetailListings(activeCategoryId);
            else window.renderCategoryHistory(activeCategoryId);
        };

        window.renderCategoryHistory = function(catId) {
            const body = document.getElementById('detail-history-body'); if(!body) return;
            body.innerHTML = '';
            const filtered = transactionHistory.filter(t => t.categoryId === catId);
            if(filtered.length === 0) { body.innerHTML = '<tr><td colspan="4" class="py-20 text-center opacity-40 uppercase tracking-widest italic">No entries</td></tr>'; return; }
            filtered.forEach(tx => {
                const row = document.createElement('tr'); row.className = 'hover:bg-black/[0.01] transition-all text-black';
                row.innerHTML = `<td class="pl-8 py-4 text-black"><div class="w-12 h-12 rounded-full overflow-hidden border border-black/5 bg-white shadow-sm p-0.5 text-black"><img src="${tx.image}" class="w-full h-full object-cover rounded-full"></div></td><td class="px-4 py-6 opacity-40 text-black">${tx.date}</td><td class="px-4 py-6 font-black uppercase italic text-black">${tx.itemName}</td><td class="px-4 py-6 text-right pr-8 font-black leading-none text-black">¥${tx.price}</td>`;
                body.appendChild(row);
            });
        };

        window.toggleMainTab = function(tab, push = true) {
            currentMainTab = tab;
            const collectionCont = document.getElementById('collection-container');
            const favoritesCont = document.getElementById('favorites-container');
            const historyCont = document.getElementById('global-history-container');
            const tabs = { collection: 'tab-collection', watchlist: 'tab-watchlist', favorites: 'tab-favorites', history: 'tab-history' };
            if (push) history.pushState({ view: 'list', tab: tab }, "");
            window.showListView(false);
            Object.values(tabs).forEach(id => { const el = document.getElementById(id); if(el) el.classList.remove('active'); });
            const activeTabEl = document.getElementById(tabs[tab]); if(activeTabEl) activeTabEl.classList.add('active');

            if (tab === 'history') {
                collectionCont.classList.add('hidden'); favoritesCont.classList.add('hidden'); historyCont.classList.remove('hidden');
                document.getElementById('main-title').innerText = 'Market Activity'; window.renderGlobalHistory();
            } else if (tab === 'favorites') {
                collectionCont.classList.add('hidden'); favoritesCont.classList.remove('hidden'); historyCont.classList.add('hidden');
                document.getElementById('main-title').innerText = 'Favorites'; window.renderFavoriteItems();
            } else {
                collectionCont.classList.remove('hidden'); favoritesCont.classList.add('hidden'); historyCont.classList.add('hidden');
                document.getElementById('main-title').innerText = tab === 'collection' ? 'Dashboard' : 'Watchlist'; window.renderList();
            }
        };

        window.updateDetailStar = function() {
            const star = document.getElementById('detail-star');
            if (star) { star.innerText = watchlist.has(activeCategoryId) ? '★' : '☆'; star.classList.toggle('active', watchlist.has(activeCategoryId)); }
        };

        window.showItemDetail = function(item, push = true) {
            window.currentFilteringItem = item; if (push) history.pushState({ view: 'item', item: item }, "");
            document.getElementById('item-detail-title').innerText = item.name;
            document.querySelectorAll('#item-detail-price').forEach(el => el.innerText = item.price);
            document.getElementById('item-detail-highest-offer').innerText = item.highestOffer ? `¥${item.highestOffer.toLocaleString()}` : "--";
            document.getElementById('item-detail-description').innerText = (item.description || "Authentication required.") + (item.accessories ? "\n\n付属品: " + item.accessories : "");
            
            const track = document.getElementById('item-carousel-track');
            const thumbs = document.getElementById('item-detail-thumbnails');
            const dots = document.getElementById('carousel-dots');
            const counter = document.getElementById('carousel-counter');
            
            const imgs = Array.isArray(item.images) ? item.images : [item.image];
            track.innerHTML = imgs.map(src => `
                <div class="min-w-full h-full snap-center flex-shrink-0 flex items-center justify-center zoom-container overflow-hidden">
                    <img src="${src}" class="max-w-full max-h-full object-contain main-img">
                    <div class="loupe" style="background-image: url('${src}');"></div>
                </div>`).join('');
            
            const containers = track.querySelectorAll('.zoom-container');
            containers.forEach(container => {
                const loupe = container.querySelector('.loupe');
                container.onmousemove = (e) => {
                    loupe.style.display = 'block';
                    const rect = container.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const loupeSize = 300;
                    let left = x - loupeSize / 2;
                    let top = y - loupeSize / 2;
                    if (left < 0) left = 0; if (left > rect.width - loupeSize) left = rect.width - loupeSize;
                    if (top < 0) top = 0; if (top > rect.height - loupeSize) top = rect.height - loupeSize;
                    loupe.style.left = `${left}px`; loupe.style.top = `${top}px`;
                    loupe.style.backgroundSize = `${rect.width * 2.5}px ${rect.height * 2.5}px`;
                    loupe.style.backgroundPosition = `${(x / rect.width) * 100}% ${(y / rect.height) * 100}%`;
                };
                container.onmouseleave = () => { loupe.style.display = 'none'; };
            });

            thumbs.innerHTML = imgs.map((src, i) => `<div onclick="document.getElementById('item-carousel-track').scrollTo({left: document.getElementById('item-carousel-track').offsetWidth * ${i}, behavior: 'smooth'})" class="w-16 h-16 rounded-xl border-2 border-transparent overflow-hidden flex-shrink-0 cursor-pointer hover:opacity-80 transition-all text-black"><img src="${src}" class="w-full h-full object-cover"></div>`).join('');
            dots.innerHTML = imgs.map((_, i) => `<div class="dot h-1.5 w-1.5 rounded-full bg-black/20 ${i===0?'active':''}"></div>`).join('');
            counter.textContent = `1 / ${imgs.length}`;

            track.onscroll = () => {
                const index = Math.round(track.scrollLeft / track.offsetWidth);
                counter.textContent = `${index + 1} / ${imgs.length}`;
                dots.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i===index));
                thumbs.querySelectorAll('div').forEach((t, i) => t.classList.toggle('border-black', i===index));
            };

            const imgContainer = document.getElementById('item-detail-carousel-container');
            const oldSold = imgContainer.querySelector('.sold-ribbon'); if (oldSold) oldSold.remove();
            if (item.sold) {
                const soldLabel = document.createElement('div'); soldLabel.className = 'sold-ribbon'; soldLabel.innerHTML = '<span>SOLD</span>';
                imgContainer.appendChild(soldLabel);
                const btnBuy = document.getElementById('buy-button'); if(btnBuy){ btnBuy.disabled = true; btnBuy.innerText = 'SOLD OUT'; }
            } else {
                const btnBuy = document.getElementById('buy-button'); if(btnBuy){ btnBuy.disabled = false; btnBuy.innerText = 'BUY / 注文を確定する'; }
            }
            const badge = document.getElementById('item-detail-condition-badge');
            if (badge) { badge.innerText = item.condition; badge.className = `mt-2 inline-block px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest shadow-sm text-white ${item.condition.includes('新品') ? 'bg-black' : 'bg-red-600'}`; }
            
            const btnBack = document.getElementById('btn-back-to-category');
            if(btnBack) btnBack.onclick = () => window.showDetail(item.categoryId);
            [listView, detailView, itemView].forEach(v => { if(v){ v.style.display = 'none'; v.classList.add('hidden-view'); } });
            if(itemView){ itemView.style.display = 'block'; setTimeout(() => itemView.classList.remove('hidden-view'), 50); }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.handleCardNav = function(event, itemId, direction) {
            event.stopPropagation();
            const el = document.getElementById(`card-carousel-${itemId}`);
            if (el) {
                const width = el.offsetWidth;
                const divs = el.querySelectorAll('div');
                const count = divs.length;
                const currentIndex = Math.round(el.scrollLeft / width);
                let nextIndex = (currentIndex + direction + count) % count;
                el.scrollTo({ left: width * nextIndex, behavior: 'smooth' });
            }
        };

        window.renderList = () => {
            if (!tbody) return; tbody.innerHTML = '';
            categories.forEach((cat, i) => {
                if (currentMainTab === 'watchlist' && !watchlist.has(cat.id)) return;
                const row = document.createElement('tr'); row.className = 'registry-row cursor-pointer group italic text-black transition-all'; row.onclick = () => window.showDetail(cat.id);
                row.innerHTML = `<td class="pl-8 py-7 text-center text-black text-black"><span onclick="window.toggleWatchlist(event, ${cat.id})" class="star-icon ${watchlist.has(cat.id) ? 'active' : ''}">${watchlist.has(cat.id) ? '★' : '☆'}</span></td><td class="px-4 py-7 text-neutral-400 text-[10px] font-black font-mono center opacity-40 group-hover:opacity-100 group-hover:text-black text-black text-black">${(i + 1).toString().padStart(2, '0')}</td><td class="px-4 py-6 flex items-center space-x-6 text-black text-black text-black"><div class="w-16 h-16 rounded-2xl overflow-hidden border border-black/[0.04] group-hover:scale-105 transition-all shadow-lg bg-neutral-50 p-0.5 text-black text-black text-black"><img src="${cat.img}" class="w-full h-full object-cover rounded-2xl"></div><div class="font-black uppercase text-black italic text-lg tracking-tighter text-black text-black text-black">${cat.name}</div></td><td class="px-4 py-7 text-black text-black text-black text-black"><div class="inline-flex items-center glass px-4 py-2 rounded-full border border-black/[0.08] bg-white/40 text-black font-black text-base italic shadow-sm">¥${cat.floor}〜</div></td><td class="px-4 py-7 text-right pr-12 font-bold italic font-mono text-base tracking-widest ${cat.change.startsWith('+') ? 'text-emerald-600' : 'text-red-600'} transition-all text-black text-black text-black">${cat.change}</td>`;
                tbody.appendChild(row);
            });
        };

        window.renderDetailListings = (catId) => {
            if(!listingsGrid) return; listingsGrid.innerHTML = '';
            if(!categorySamples[catId]) {
                categorySamples[catId] = []; const cat = categories.find(c=>c.id===catId);
                const bp = parseInt(cat.floor.replace(/,/g, ''));
                for(let i=0; i<12; i++) {
                    const rp = bp + Math.floor(Math.random() * 50) * 10000;
                    categorySamples[catId].push({ id: `s-${catId}-${i}`, categoryId: catId, name: `${cat.name} Ref.MOD-${100+i}`, price: rp.toLocaleString(), priceVal: rp, condition: Math.random() > 0.4 ? "中古(普通)" : "新品", images: [cat.img], highestOffer: Math.floor(rp * 0.9), sold: false, description: "Authentic registry item.", accessories: "全てあり" });
                }
            }
            let items = [...(individualListings.filter(l=>l.categoryId === catId)), ...categorySamples[catId]];
            if (currentFilter !== 'all') items = items.filter(it => it.condition.includes(currentFilter));
            if (currentSort === 'price-asc') items.sort((a,b) => a.priceVal - b.priceVal);
            else if (currentSort === 'price-desc') items.sort((a,b) => b.priceVal - a.priceVal);
            
            items.forEach(it => {
                const imgs = Array.isArray(it.images) ? it.images : [it.image];
                const card = document.createElement('div');
                card.className = 'glass rounded-[40px] p-4 border border-black/[0.04] cursor-pointer hover:border-black transition-all flex flex-col h-full shadow-lg italic group bg-white/30 hover:bg-white/70 overflow-hidden relative text-black';
                card.onclick = () => window.showItemDetail(it);
                card.innerHTML = `
                    <div class="aspect-square rounded-[28px] overflow-hidden mb-4 bg-neutral-50 relative shadow-inner border border-black/[0.03] p-1 text-black ${it.sold ? 'opacity-50' : ''}">
                        <div id="card-carousel-${it.id}" class="w-full h-full flex snap-x no-scrollbar overflow-x-auto text-black text-black text-black">
                            ${imgs.map(src => `<div class="min-w-full h-full snap-center text-black text-black text-black text-black"><img src="${src}" class="w-full h-full object-cover rounded-[24px]"></div>`).join('')}
                        </div>
                        <span onclick="window.toggleFavoriteItem(event, '${it.id}')" class="heart-icon ${favoriteItemIds.has(it.id) ? 'active' : ''}">${favoriteItemIds.has(it.id) ? '❤' : '♡'}</span>
                        ${it.sold ? '<div class="sold-ribbon"><span>SOLD</span></div>' : ''}
                        <button onclick="window.handleCardNav(event, '${it.id}', -1)" class="nav-btn absolute left-2 top-1/2 -translate-y-1/2 w-6 h-6 flex items-center justify-center rounded-full bg-black/10 text-white z-20 text-black text-black text-black"><svg class="w-4 h-4 text-black" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg></button>
                        <button onclick="window.handleCardNav(event, '${it.id}', 1)" class="nav-btn absolute right-2 top-1/2 -translate-y-1/2 w-6 h-6 flex items-center justify-center rounded-full bg-black/10 text-white z-20 text-black text-black text-black"><svg class="w-4 h-4 text-black" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg></button>
                        <div class="absolute top-4 left-4 ${it.condition.includes('新品') ? 'bg-black' : 'bg-red-600'} text-white px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest shadow-sm text-white text-white text-white text-white text-white text-white text-white">${it.condition}</div>
                        <div id="card-counter-${it.id}" class="absolute bottom-4 right-4 bg-black/40 text-white text-[8px] px-1.5 py-0.5 rounded font-black tracking-tighter text-white">1 / ${imgs.length}</div>
                    </div>
                    <div class="font-mono text-black flex-grow flex flex-col justify-between px-1 ${it.sold ? 'opacity-30' : ''} text-black text-black text-black text-black">
                        <h4 class="font-black text-[11px] uppercase truncate mb-2 group-hover:text-emerald-600 transition-colors text-black text-black text-black text-black">${it.name}</h4>
                        <div class="flex justify-between items-baseline pt-2 text-black text-black">
                            <div class="text-xl font-black text-black italic tracking-tighter leading-none price-glow text-black text-black text-black text-black text-black text-black text-black">¥${it.price}</div>
                            <div class="text-right text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black"><span class="text-[7px] text-gray-400 uppercase font-bold block mb-0.5 text-black">offer</span><span class="text-[10px] font-black text-emerald-600 leading-none text-black text-black text-black text-black">¥${it.highestOffer.toLocaleString()}</span></div>
                        </div>
                    </div>`;

                const carousel = card.querySelector(`#card-carousel-${it.id}`);
                if(carousel) {
                    carousel.onscroll = () => {
                        const idx = Math.round(carousel.scrollLeft / carousel.offsetWidth);
                        const counter = card.querySelector(`#card-counter-${it.id}`);
                        if(counter) counter.textContent = `${idx + 1} / ${imgs.length}`;
                    };
                }
                listingsGrid.appendChild(card);
            });
        };

        window.renderFavoriteItems = () => {
            const grid = document.getElementById('favorites-grid'); if(!grid) return;
            grid.innerHTML = '';
            let favs = [];
            Object.values(categorySamples).forEach(arr => arr.forEach(it => { if (favoriteItemIds.has(it.id)) favs.push(it); }));
            individualListings.forEach(it => { if (favoriteItemIds.has(it.id)) favs.push(it); });
            if (favs.length === 0) { grid.innerHTML = '<div class="col-span-full py-24 text-center opacity-30 font-black tracking-widest text-black">No favorites yet.</div>'; return; }
            favs.forEach(it => {
                const card = document.createElement('div'); card.className = 'glass rounded-[40px] p-4 border border-black/[0.04] cursor-pointer hover:border-black transition-all flex flex-col h-full shadow-lg italic group bg-white/30 hover:bg-white/70 overflow-hidden relative text-black text-black text-black'; card.onclick = () => window.showItemDetail(it);
                card.innerHTML = `<div class="aspect-square rounded-[28px] overflow-hidden mb-4 bg-neutral-50 relative shadow-inner border border-black/[0.03] p-1 text-black ${it.sold ? 'opacity-50' : ''}"><span onclick="window.toggleFavoriteItem(event, '${it.id}')" class="heart-icon active text-black text-black text-black text-black text-black">❤</span>${it.sold ? '<div class="sold-ribbon text-black text-black"><span>SOLD</span></div>' : ''}<img src="${Array.isArray(it.images)?it.images[0]:it.image}" class="w-full h-full object-cover rounded-[24px] transition-transform duration-700 group-hover:scale-105 text-black"><div class="absolute top-4 left-4 ${it.condition.includes('新品') ? 'bg-black' : 'bg-red-600'} text-white px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest shadow-sm text-white text-white text-white text-white">${it.condition}</div></div><div class="font-mono text-black flex-grow flex flex-col justify-between px-1 ${it.sold ? 'opacity-30' : ''} text-black text-black text-black text-black text-black text-black text-black text-black text-black"><h4 class="font-black text-[11px] uppercase truncate mb-2 group-hover:text-emerald-600 transition-colors text-black text-black text-black">${it.name}</h4><div class="flex justify-between items-baseline pt-2 text-black text-black text-black text-black text-black text-black text-black text-black text-black"><div class="text-xl font-black text-black italic tracking-tighter leading-none price-glow text-black text-black text-black text-black text-black text-black text-black text-black text-black">¥${it.price}</div><div class="text-right text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black"><span class="text-[7px] text-gray-400 uppercase font-bold block mb-0.5 text-black">offer</span><span class="text-[10px] font-black text-emerald-600 leading-none text-black text-black text-black text-black text-black">¥${it.highestOffer.toLocaleString()}</span></div></div></div>`;
                grid.appendChild(card);
            });
        };

        window.renderGlobalHistory = () => {
            const body = document.getElementById('global-history-body'); if(!body) return;
            body.innerHTML = '';
            transactionHistory.forEach(tx => {
                const row = document.createElement('tr'); row.className = 'hover:bg-black/[0.01] transition-all text-black';
                row.innerHTML = `<td class="pl-8 py-4 text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black"><div class="w-12 h-12 rounded-full overflow-hidden border border-black/5 bg-white shadow-sm p-0.5 text-black"><img src="${tx.image}" class="w-full h-full object-cover rounded-full text-black"></div></td><td class="px-4 py-6 opacity-40 text-black">${tx.date}</td><td class="px-4 py-6 font-black uppercase italic text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black">${tx.itemName}</td><td class="px-4 py-6 text-right pr-8 font-black leading-none text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black text-black">¥${tx.price}</td>`;
                body.appendChild(row);
            });
        };

        window.handlePurchaseClick = function() {
            if (!window.currentFilteringItem) return; window.currentFilteringItem.sold = true;
            const now = new Date(); const ds = `${now.getFullYear()}.${(now.getMonth()+1).toString().padStart(2, '0')}.${now.getDate().toString().padStart(2, '0')}`;
            transactionHistory.unshift({ id: `TX-${Date.now()}`, date: ds, itemName: window.currentFilteringItem.name, categoryName: categories.find(c => c.id === window.currentFilteringItem.categoryId).name, categoryId: window.currentFilteringItem.categoryId, type: 'SALE', price: window.currentFilteringItem.price, image: Array.isArray(window.currentFilteringItem.images)?window.currentFilteringItem.images[0]:window.currentFilteringItem.image });
            window.showToast("Order Accepted", "ご注文を受け付けました。"); window.showItemDetail(window.currentFilteringItem, false);
        };

        window.openModal = () => document.getElementById('listing-modal').style.display = 'flex';
        window.closeModal = () => { document.getElementById('listing-modal').style.display = 'none'; document.getElementById('listing-form').reset(); imageGrid.querySelectorAll('.image-card:not(#upload-label)').forEach(c => c.remove()); imagesCount = 0; };
        
        window.showToast = (t, m) => { 
            const el = document.getElementById('toast'); if(!el) return;
            el.querySelector('#toast-title').innerText = t; el.querySelector('#toast-message').innerText = m; 
            el.classList.remove('hidden'); el.classList.add('show'); 
            setTimeout(()=>el.classList.remove('show'), 3500); setTimeout(()=>el.classList.add('hidden'), 3800);
        };

        window.handleListingSubmit = async (e) => {
            e.preventDefault();
            const imgs = Array.from(imageGrid.querySelectorAll('.image-card:not(#upload-label) img')).map(img => img.src);
            if (imgs.length === 0) return window.showToast("Error", "写真を1枚以上追加してください");
            individualListings.unshift({ 
                id: `u-${Date.now()}`, categoryId: parseInt(categorySelect.value), name: document.getElementById('form-name').value, 
                price: parseInt(document.getElementById('form-price').value).toLocaleString(), priceVal: parseInt(document.getElementById('form-price').value), 
                condition: document.getElementById('form-condition-select').value, images: imgs, isUserListed: true, highestOffer: 0, sold: false, 
                description: document.getElementById('form-description').value, accessories: document.getElementById('form-accessories-select').value 
            });
            window.closeModal(); window.showToast("Success", "Registry confirmed."); if (activeCategoryId === parseInt(categorySelect.value)) window.toggleDetailTab('collection');
        };

        window.handleFileSelect = async (e) => {
            const files = Array.from(e.target.files);
            const remaining = 10 - imagesCount;
            for (const file of files.slice(0, remaining)) {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const squareSrc = await window.fitToSquare(event.target.result);
                    window.addImageToGrid(squareSrc, event.target.result);
                };
                reader.readAsDataURL(file);
            }
            e.target.value = '';
        };

        window.toggleWatchlist = (e, id) => { if (e) e.stopPropagation(); if (watchlist.has(id)) watchlist.delete(id); else watchlist.add(id); window.renderList(); if (activeCategoryId === id) window.updateDetailStar(); };
        window.toggleWatchlistFromDetail = () => { if (activeCategoryId) window.toggleWatchlist(null, activeCategoryId); };
        window.toggleFavoriteItem = (e, itemId) => { if (e) e.stopPropagation(); if (favoriteItemIds.has(itemId)) favoriteItemIds.delete(itemId); else favoriteItemIds.add(itemId); window.renderDetailListings(activeCategoryId); if (currentMainTab === 'favorites') window.renderFavoriteItems(); };
        window.updateFilter = (f) => { currentFilter = f; window.renderDetailListings(activeCategoryId); };
        window.updateSort = (s) => { currentSort = s; window.renderDetailListings(activeCategoryId); };

        window.openAuthModal = () => { document.getElementById('auth-modal').style.display = 'flex'; };
        window.closeAuthModal = () => { document.getElementById('auth-modal').style.display = 'none'; };
        window.toggleAuthMode = () => { window.authMode = window.authMode === 'login' ? 'signup' : 'login'; document.getElementById('auth-modal-title').innerText = window.authMode === 'login' ? 'Member Registry' : 'New Registration'; document.getElementById('btn-auth-submit').innerText = window.authMode === 'login' ? 'Sign In' : 'Register Account'; document.getElementById('btn-auth-toggle').innerText = window.authMode === 'login' ? 'Create New Account' : 'Already have an account?'; };
        
        window.updateAuthUI = (u) => { 
            const c = document.getElementById('auth-status-container'); const banner = document.getElementById('verify-banner');
            if (u) { 
                c.innerHTML = `<div class="flex items-center space-x-3 text-black text-black text-black text-black text-black text-black"><p class="text-[9px] font-black font-mono italic opacity-40 truncate max-w-[100px] text-neutral-400 text-black text-black text-black text-black text-black text-black text-black text-black">${u.email || 'User'}</p><button onclick="window.handleLogout()" class="text-[9px] font-black uppercase tracking-widest text-red-600 hover:text-red-800 transition text-black">Logout</button></div>`;
                if (!u.emailVerified) banner.classList.remove('hidden'); else banner.classList.add('hidden');
            } else { 
                c.innerHTML = `<button onclick="window.openAuthModal()" class="text-[10px] font-black uppercase tracking-widest text-neutral-400 hover:text-black transition px-4 text-neutral-400 text-black">Sign In</button>`; 
                banner.classList.add('hidden');
            } 
        };

        window.initThree = () => {
            const cnt = document.getElementById('three-canvas'); if(!cnt) return;
            sc = new THREE.Scene(); cam = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            rend = new THREE.WebGLRenderer({alpha:true, antialias:true}); rend.setSize(window.innerWidth, window.innerHeight);
            cnt.appendChild(rend.domElement);
            cub = new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(4.5, 4.5, 4.5)), new THREE.LineBasicMaterial({color:0x000000, linewidth: 1}));
            sc.add(cub); cam.position.z = 10;
        };
        window.animate = () => { requestAnimationFrame(window.animate); if(typeof cub !== 'undefined' && cub){ cub.rotation.x+=0.0008; cub.rotation.y+=0.0008; } if(rend) rend.render(sc, cam); };

        onpopstate = (e) => {
            if (e.state) {
                const s = e.state;
                if (s.view === 'list') window.toggleMainTab(s.tab || 'collection', false);
                else if (s.view === 'detail') window.showDetail(s.id, false);
                else if (s.view === 'item') window.showItemDetail(s.item, false);
            } else window.showListView(false);
        };

        window.addEventListener('load', () => { 
            window.initializeDOMElements(); window.initThree(); window.animate(); window.renderList(); 
            const catSel = document.getElementById('form-category');
            if(catSel) catSel.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        });
    </script>
</body>
</html>
